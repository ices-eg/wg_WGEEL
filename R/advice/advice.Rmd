---
title: "European eel (*Anguilla anguilla*) throughout its natural range"
documentclass: report
output: 
  officedown::rdocx_document:
    tables:
      caption:
       style: Table Caption
       pre: ''
       sep: ''
    plots:
      caption:
        style: Image Caption
        pre: ''
        sep: ''
    fig_caption: yes
    number_sections: no
    reference_docx: "ele.2737.nea_v3_2024_10_11.docx"
    mapstyles:
      'Heading 3': Title 
      'Hheading 3': 'Heading 1'
      'Normal': [Bibliography, 'First Paragraph']
editor_options: 
  markdown: 
    wrap: 72
bibliography: advice.bib
csl: "../Rmarkdown/ices-journal-of-marine-science.csl"
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE, error=FALSE}
CY <- lubridate::year(Sys.Date())
getUsername <- function(){
	name <- Sys.info()[["user"]]
	return(name)
}

if (getUsername() == "cedric.briand") setwd("C:/workspace/wg_WGEEL/R/advice") 
if (getUsername() %in% c("hilaire.drouineau", "hdrouineau") ) setwd("/home/hdrouineau/Documents/Bordeaux/migrateurs/WGEEL/github/wg_WGEEL/R/advice") 
getwd()
source(paste0("../recruitment/utilities.R"))
library(knitr)
library(stringr)
datawd <- paste0(getwd(), "/../recruitment/",CY,"/data/")
imgwd <- paste0(getwd(), "/../recruitment/",CY,"/image/")
keyfigfiles <- list.files(path = paste0("../Rmarkdown/", CY, "/00international/data/"),
                          full.names = TRUE)
for (f in keyfigfiles) load(f)
load(file=str_c(datawd,"wger_init.Rdata"))
load(file=str_c(datawd,"statseries.Rdata"))
load(file=str_c(datawd,"R_stations.Rdata"))
load(file=str_c(datawd,"t_series_ser.Rdata"))
load(file=str_c(datawd,"last_years_with_problem.Rdata"))
selection = select_series(wger_init, R_stations)
selection_summary <- selection$selection_summary

flextable2ICES <- function(x){
  x |>
    font(fontname = "Calibri", part = "all") |>
    fontsize(size = 9, part = "all")
}


opts_knit$set(eval.after = "fig.cap",
		echo=FALSE,
		warning = FALSE,
		message = FALSE,
		error=FALSE)
Sys.setlocale("LC_ALL", "English_United States.932")
#options(save.defaults = list(version=2))
# Password are stored in R/etc/Rprofile.site
# For the moment the database is stored locally
CY <- 2025 # current year ==> dont forget to update the graphics path below
opt_calculation <- "geomean" # "geomean" or "mean"
opt_std <- "all" #"1979-1994" or "2000-2009" or "all"

options(width=90) # this sets the width of the output
#--------------------------------
# packages used by this script
#--------------------------------
#if(!require(RODBC)) install.packages("RODBC") ; require(RODBC)
library(flextable)
if(!require(officedown)) install.packages("officedown") ; require(officedown)
if(!require(ftExtra)) install.packages("ftExtra") ; require(ftExtra)

if(!require(officer)) install.packages("officer") ; require(officer)
if(!require(prettymapr)) install.packages("prettymapr") ; require(prettymapr)
if(!require(ggmagnify)) install.packages("ggmagnify", repos = c("https://hughjonesd.r-universe.dev", 
                 "https://cloud.r-project.org")) ; require(ggmagnify)

if(!require(ggplot2)) install.packages("ggplot2") ; require(ggplot2)
if(!require(stringr)) install.packages("stringr") ; require(stringr)
if(!require(patchwork)) install.packages("patchwork") ; require(patchwork)
if(!require(yaml)) install.packages("yaml") ; require(yaml)

if(!require(stringr)) install.packages("stringr") ; require(stringr)
if(!require(dplyr)) install.packages("dplyr") ; require(dplyr)


if(!require(tidyr)) install.packages("dplyr") ; require(tidyr)
set_flextable_defaults(
  font.size = 8.5, font.family = "Calibri",
  font.color = "black",
  table.layout = "autofit",
  border.color = "black",
  padding.top = 3, padding.bottom = 3,
  padding.left = 4, padding.right = 4)


redtext <- fp_text(color = 'red', bold = TRUE)
purpletext <- fp_text(color = 'purple', bold = TRUE)
graphics.off() # close all graphics devices
# the results will be stored in a list, when I first run the program,
# on the second run this list will be loaded and I can avoid some steps in the calculation
# by setting the chunks as eval=FALSE
wddata <- paste0(getwd(), "/../recruitment")
datawd <- str_c(wddata,"/",CY,"/data/")
outputdatawd <- str_c(wddata,"/",CY,"/data/")
imgwd <- str_c(wddata,"/",CY,"/image/")

load(str_c(outputdatawd,"dat_ge.Rdata"))
load(str_c(outputdatawd,"dat_ye.Rdata"))
load(str_c(outputdatawd,"mohn.Rdata"))
load("../shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata") 
# now data are generated by the script load_data_from_the_database.R
load("../shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")

source("../utilities/load_library.R")

wd <-getwd()
setwd("../shiny_data_visualisation/shiny_dv")
source("database_connection.R")
source("database_reference.R")
source("database_data.R")
source("database_precodata.R")
source("preco_diagram.R")
source("graphs.R")
source("maps.R")
source("filter_and_group_functions.R")
source("predict_missing.R")
setwd(wd)

```

# ICES advice on fishing opportunities

ICES advises that when the precautionary approach is applied, there
should be zero catches in all habitats in `r CY+1`. This applies to both
recreational and commercial catches and includes catches of glass eels
for restocking and aquaculture.

<br>

# Non-fisheries conservation considerations

Based on ecosystem‑based management, ICES considers that:

- all non-fisheries related anthropogenic mortalities should be reduced to
zero. 
- the quantity and quality of eel habitats should be restored;
this includes restoring connectivity and the physical, chemical, and
biological properties of the habitats.

<br>

# Stock development over time

The status of European eel remains critical. ICES cannot assess the exploitation 
status relative to maximum
sustainable yield (MSY) or precautionary approach (PA) reference points
because the reference points are undefined. The 1960–1979 geometric mean
recruitment is considered a likely limit reference point (Rlim). Given
that the current recruitment estimate has been below Rlim for many
years, it is assumed that current biomass is below a potential Blim.
Therefore, while stock-size reference points are also undefined, it is
considered that the stock size is well below potential biological limit
reference points.


```{r, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.ncol=2}
knitr::include_graphics(paste0(imgwd,"figure_advice.png"))

```


::: {custom-style="Image Caption"}
__Figure 1__ <tab> Indices of glass eel recruitment for the continental “North Sea” 
(top‑left panel) and “Elsewhere Europe” (top‑right panel) series. A statistical 
model was fitted to `r selection_summary$nb_series_glass_eel` time-series 
comprising either pure glass eel or a mixture of glass and yellow eels 
(`r unlist(selection_summary$nb_series_glass_eel_per_area[2,2])` “North Sea” and
`r unlist(selection_summary$nb_series_glass_eel_per_area[1,2])` “Elsewhere Europe”).
The results were scaled in percentage to the 1960–1979 geometric mean (Standardised GLM recruitment).
The “North Sea” series are from Norway, Sweden, Germany, Denmark, the Netherlands,
UK, and Belgium; the “Elsewhere” series are from UK, Ireland, France, Spain, 
Portugal, and Italy. In the Baltic area, recruitment occurs at the yellow eel 
stage only, and series are thus not included in the glass eel recruitment index.
Bottom panel: estimated yellow eel recruitment trends for Europe. A statistical 
model was fitted to `r selection_summary$nb_series_older` yellow eel 
time-series and scaled in percentage to the 1960–1979 geometric mean 
(Standardised GLM recruitment). The series are from Denmark, Germany, Ireland, Sweden, 
France, and UK. The horizontal blue line on each panel represents the likely 
Rlim (calculated from the 1960–1979 geometric mean). Ribbons show 95% prediction 
interval of the GLM (1.96 × standard error).
:::

<br>

# Conservation status [^1]

[^1]: This is for information purposes, and ICES does not formally
endorse the methods used by third parties to create lists.

Non-fisheries related anthropogenic mortalities are not reliably
quantified [@ices2025], and no reference points are defined.

European eel has been listed as Critically Endangered on the
International Union for the Conservation of Nature (IUCN) Red List since
2008 [@pike2020; @iucn2022]. It was listed in Appendix II of the
Convention on International Trade of Endangered Species (CITES) in 2007
that came into force in 2009
[@conventiononinternationaltradeinendangeredspeciesofwildfaunaandfloracites2007;
@conventiononinternationaltradeiendangeredspeciesofwildfaunaandfloracites2022],
and Appendix II of the Conservation of Migratory Species of Wild Animals
(CMS) in 2014
[@conventionontheconservationofmigratoryspeciesofwildanimalscms2018].

European eel was added to the OSPAR List of Threatened and/or Declining
Species and Habitats in 2008. The status of European eel is still very
poor in all OSPAR regions [@ospar2022].

European eel was assessed as Critically Endangered by HELCOM in the
Baltic Region [@helcom2025].

<br>

# Catch scenarios

In the absence of an analytical assessment and accurate catch
information, ICES is not in a position to provide catch scenarios.

<br>

# Basis of the advice

::: {custom-style="Table Caption"}
__Table 1a__&nbsp;    The basis of the advice for **fishing opportunities**.
:::

```{r , tab.id="basisfishing", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
library(readxl)
library(flextable)
basis <- readxl::read_excel("advice_basis_fishing.xlsx", col_names = FALSE)
flextable(basis) |>
  delete_part() |>
    ftExtra::colformat_md() |>
  bg(j = 1, bg = "#e8eaea", part = "all") |>
  width(1, width = 2.36, "cm") |>
  width(2, width = 15, "cm") |>
  border_inner() |>
  border_outer() |>
  set_table_properties(width = 1, layout = "fixed") |>
  flextable2ICES()
```

<br>

<br>

::: {custom-style="Table Caption"}
__Table 1b__&nbsp;    The basis of the advice for **conservation aspects**.
:::

```{r , tab.id = "basis", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
library(readxl)
library(flextable)
basis <- readxl::read_excel("advice_basis.xlsx", col_names = FALSE)
flextable(basis)|>
  delete_part() |>
    ftExtra::colformat_md() |>
  bg(j = 1, bg = "#e8eaea", part = "all") |>
  width(1, width = 2.36, "cm") |>
  width(2, width = 15, "cm") |>
  border_inner() |>
  border_outer() |>
  set_table_properties(width = 1, layout = "fixed") |>
  flextable2ICES()
```

<br>

# Quality of the assessment

The assessment is based on two glass eel recruitment indices and a
yellow eel recruitment index, each comprising multiple time-series. The
indices are fitted based on data from fisheries and scientific surveys,
forming the longest and most reliable time-series that constitute an
index of abundance.

The addition of new data points to all three recruitment indices
naturally causes changes in GLM predictions of past years. Mohn’s Rho is
calculated to evaluate the consistency of the assessment in retrospect
(Figure 2). Mohn’s Rho is `r round(mohn_EE/100, 2)` for the ”Elsewhere
Europe” index, `r round(mohn_NS/100, 2)` for the ”North Sea” index, and
`r round(mohn_YY/100, 2)` for the ”Yellow eel” index. While exceeding 0.2,
which is generally considered as a threshold of concern [@ices2023j],
the number of series used in the eel indices may vary between assessment
years, e.g. because of the inclusion of new series or replacement of
existing series with other monitoring activities in the same area. This
may cause additional variation of Mohn’s Rho compared to a situation
where variation is caused only by the addition of new data points in
recent years.


```{r, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
knitr::include_graphics(paste0(imgwd,"retro_patchwork.png"))
```


::: {custom-style="Image Caption"}
__Figure 2__&nbsp;  European eel. Retrospective comparison of generalized linear
model (GLM) recruitment trends for “North Sea” 
(Mohn’s ρ = `r round(mohn_NS/100, 2)`), “Elsewhere Europe” (Mohn’s ρ = `r round(mohn_EE/100, 2)`
), and “Yellow eel” (Mohn’s ρ = `r round(mohn_YY/100, 2)` recruitment. The GLM 
predictions of past years change with the addition of new data points for 
the most recent year and/or the addition/removal of data series. Years indicated
in the legend (`r CY-4`–`r CY`) show GLM predictions based on the data available 
in the given year for glass eel (“North Sea” and “Elsewhere Europe”) and yellow 
eel indices, respectively.
:::

<br>

In the absence of precise quantitative information on the spatial
distribution of recruitment, the model does not weight time-series. As a
consequence, a time-series collected in a zone with low recruitment has
the same weight as one collected in a zone of higher recruitment.
Moreover, in the absence of weighting, regions with numerous time-series
have a greater weight than data-limited regions in the resulting
recruitment index.

Total landings and effort data are incomplete [@ices2024b]. In addition,
a great heterogeneity is present among the time-series of landings owing
to inconsistencies in reporting by, and between, countries. Changes in
eel management practices have also affected commercial and
non-commercial/recreational fisheries and the reporting of these
fisheries.

Data deficiencies in reports on recreational fisheries are described by
ICES [@ices2016b]. Although this has improved, landings in recreational
fisheries remain largely unquantified [@ices2024b]. Estimates from
countries, where available, show that landings of yellow and silver eels
from recreational fisheries can be of the same order of magnitude as
those of commercial fisheries.

The annual eel data call, issued for the first time in 2017, has
substantially improved the coverage and completeness of the data being
reported to ICES. National estimates of biomass indicators, mortality
rates, and associated data are requested once every third year, in line
with reporting on Eel Management Plan (EMP) implementation progress to
the European Commission. The most recent call was issued in `r CY`
[@ices2025e]. Data on eel life-history parameters, fisheries, and other anthropogenic impacts
across the whole stock, however, remain incomplete because there is no
single international legislative requirement to collect and provide data
that cover the entire stock area.

<br>

# Issues relevant for the advice

**On fishing opportunities**

Total reported commercial landings and recreational catches of yellow and silver eel have
amounted to at least 2 000 tonnes per year over the last decade, with several
countries reporting annual landings of over 100 tonnes per year. Commercial glass
eel total landings amounted to at least 40 tonnes per year for the past decade. Both are in contradiction with the
advice.

-   Restocking

ICES notes that the restocking of eels (the practice of moving eels from
one waterbody to another) is intended as a conservation measure in EU
Council Regulation (EC) No. 1100/2007 [@eucouncil2007] and is
implemented in many eel management plans. Restocking is reliant on a
glass eel catch, which is in contradiction with the current advice.

The net benefit of restocking to the reproductive potential of the eel
stock is unknown. It requires information on e.g. the carrying capacity
of glass eel source estuaries, reliable mortality estimates at each step
of the restocking process, and the spawning potential of stocked vs.
non-stocked eels. While a local increase in eel production may be
apparent [@ices2016b], an assessment of net benefit to the spawning
stock was unquantifiable. When constrained by the above-mentioned
uncertainties and potential harmful effects, while following the
precautionary approach, no catch for restocking should be allowed.

-   Assisted migration

ICES acknowledges that catches for the purpose of subsequent release to
improve survival may be part of temporary conservation measures. For
example, where dams exist and prevent downstream migration of silver eel
or upstream migration of recruiting glass or yellow eels, transfer
across barriers within the same waterbody could be considered if it is
likely that the associated mortality is less than that in the absence of
such measures. Upstream assisted migration should only be applied if the
future escapement of silver eels is ensured. In such conditions, the
current advice does not apply to these catches.

-   Aquaculture

Since cultured eels are always wild caught and either permanently
removed from the stock (for consumption) or used for restocking (and
hence not for conservation purposes following the definition above), no
catch for aquaculture purposes should be allowed.

<br>

**On conservation aspects**

-   Other anthropogenic impacts

Non-fisheries anthropogenic impacts are substantial [@ices2019;
@ices2020a; @ices2021a; @ices2022a] and can be grouped into the
following: (a) hydropower, pumping stations, and other water intakes;
(b) habitat loss or degradation; (c) pollution, diseases, and parasites;
and (d) other management actions that may affect levels of predation
(e.g. conservation of predators vs. control of predators). These impacts
vary over a range of temporal and spatial scales. The objective of the EU Council 
Regulation (EC) No. 1100/2007 [@eucouncil2007] is to reduce anthropogenic 
mortalities, including non-fisheries impacts.

Global climate change has and
will continue to directly and indirectly affect both marine and
freshwater habitats, requiring similar considerations given the
likelihood of dual impacts on migratory fish such as European eel.
However, those effects from climate change are not well understood.

The implementation of environmental legislation (e.g. EU Nature Restoration Regulation, the EU Water
Framework [WFD] and the Marine Strategy Framework directives [MSFD])
aims to improve the continental environment in marine, transitional, and
freshwaters and could have a positive effect on the reproductive
potential of silver eel.

At present, ICES is not able to quantify the level and the relative
impact of non-fisheries anthropogenic factors on the stock. However, given the state of the stock, all other
anthropogenic impacts (e.g. those caused by hydropower, pumping
stations, and pollution) that negatively affect the eel stock should be zero.

<br>

*Other aspects*

Illegal, unreported, and unregulated (IUU) fishing is known to occur,
and customs seizures indicate that the illegal export of eel could be
substantial. Some countries have reported the level of misreporting and
illegal fisheries (i.e. the seizure of illegal nets as well as the
illegal trade of eels from countries both inside and outside the EU) to
ICES, EIFAAC, or GFCM. However, there are insufficient data available to
quantify their effect on the total stock size or status with any level
of certainty.

<br>

# Reference points

No biomass or fishing mortality reference points are formally defined
for this stock. For the time being, the 1960–1979 recruitment is
considered a potential limit reference point Rlim [@ices2021]

<br>

# Basis of the assessment
::: {custom-style="Table Caption"}
__Table 2__&nbsp;  European eel. Basis of the assessment.
:::

```{r, tab.id = "tab2", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
tab2 <- readxl::read_excel("table2.xlsx", col_names = FALSE)
flextable(tab2)  |>
  delete_part() |>
  bg(j = 1, bg = "#e8eaea", part = "all") |>
  width(1, width = 4.16, "cm") |>
  width(2, width = 13.25, "cm") |>
  border_inner() |>
  border_outer() |>
  set_table_properties(width = 1, layout = "fixed")|>
  flextable2ICES() |>
  ftExtra::colformat_md()
```

\* European Inland Fisheries and Aquaculture Advisory Commission

\*\* General Fisheries Commission for the Mediterranean

# History of the advice, catch, and management

::: {custom-style="Table Caption"}
__Table 3__&nbsp;  European eel. History of ICES advice.
:::

```{r , tab.id = "tab3", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
tab3 <- readxl::read_excel("table3.xlsx")
flextable(tab3) |>
  bg(bg = "#e8eaea", part = "header") |>
  width(1, width = 1.1, "cm") |>
  width(2, width = 10.65, "cm") |>
    width(3, width = 2.7, "cm") |>
    width(4, width = 1.27, "cm") |>
    width(5, width = 1.69, "cm") |>

  border_inner() |>
  border_outer() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  flextable2ICES() 
```

\* There has never been a TAC (total allowable catch) for this stock.

\*\* ICES landings estimate for the distribution range of the European eel.

<br> 

# History of catch and landings

Landings data are not complete for the entire natural range of thr European
eel.

::: {custom-style="Table Caption"}
__Table 4__&nbsp;  European eel. Commercial landings (tonnes) of glass eels 
(1945–`r CY`), as reported to ICES by EU Member States (France [FR], Spain [ES],
Portugal [PT], and Italy [IT]) and United Kingdom (GB). Empty cell = no data, 
data not collected, or data not pertinent.
:::

```{r, tab.id = "tab4", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
library(dplyr)
filtered_data <- filter_data("landings",
    typ = 4,
    life_stage = "G",
    country=c("ES","FR","IT","PT","GB")
) %>% dplyr::filter(is.na(eel_missvaluequal)) # removing data from Ireland
year <- unique(filtered_data$eel_year)
country <- unique(filtered_data$eel_cou_code)
hty <- unique(filtered_data$eel_hty_code)
grouped_data  <- group_data(filtered_data,geo="country",habitat=FALSE,lfs=FALSE,na.rm=TRUE) |>
  mutate(eel_value = eel_value/1000) |>
  pivot_wider(id_cols = all_of("eel_year"),
              names_from = eel_cou_code,
              values_from = eel_value) |>
  dplyr::rename(Year = eel_year) %>%
  mutate(Year = as.character(Year)) %>%
  mutate(Total = rowSums(. |> dplyr::select(!all_of("Year")),
                         na.rm = TRUE) ) |>
  dplyr::select(all_of(c("Year", "GB", "FR","ES", "PT", "IT", "Total")))

grouped_data$Year[nrow(grouped_data)] <- paste0(grouped_data$Year[nrow(grouped_data)],
                                                "*")




grouped_data |>
  flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  width(1, width = 4.16, "cm") |>
  width(2, width = 13.25, "cm") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  colformat_double(j = 2:7, big.mark = ",", digits = 1) |>
  flextable::align(align = "center", part = "all") |>
  flextable::align(j = 2:7, align = "right", part = "body") |>
  flextable2ICES()
```

\* Preliminary data

<br>

```{r, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

filtered_data<-filter_data("landings",
    typ = 4,
    life_stage = c("Y","S","YS"),
    year_range = 1908:CY-1
)%>% dplyr::filter(is.na(eel_missvaluequal))
year<-unique(filtered_data$eel_year)
country<-unique(filtered_data$eel_cou_code)
hty<-unique(filtered_data$eel_hty_code)
landingsYS <-group_data(filtered_data,geo="country", habitat=FALSE, lfs=FALSE, na.rm=TRUE) |>
  mutate(eel_cou_code = ifelse(eel_cou_code == "NL",
                               "NL*",
                               eel_cou_code)) |>
  mutate(eel_cou_code = ifelse(eel_cou_code == "FR",
                               "FR*",
                               eel_cou_code),
         eel_value = eel_value / 1000) |>
  pivot_wider(id_cols = all_of("eel_year"), 
              names_from = eel_cou_code,
              values_from = eel_value) |>
  dplyr::rename(Year = eel_year) |>
  mutate(Year =as.character(Year)) %>%
    mutate(Total = rowSums(. |> dplyr::select(!all_of("Year")), na.rm = TRUE)) |>
  arrange(Year)

##table
# fun.agg<-function(X){if(length(X)>0){round(sum(X,na.rm=TRUE)/1000,ifelse(sum(X,na.rm=TRUE)>1000,1,1))}else{sum(c(X,NA))}}

countries <- setdiff(names(landingsYS), c("Year", "Total"))
nbcountries <- length(countries)
set1 <- countries[seq_len(round(nbcountries/3))]
set2 <- countries[(1+round(nbcountries/3)):round(nbcountries* 2/3)]
set3 <- countries[(round(nbcountries* 2/3)+1):nbcountries]

set1names <- country_c$cou_country[match(gsub("\\*", "", set1), country_c$cou_code)]
set2names <- country_c$cou_country[match(gsub("\\*", "", set2), country_c$cou_code)]

set3names <- country_c$cou_country[match(gsub("\\*", "", set3), country_c$cou_code)]


```

<br>


::: {custom-style="Table Caption"}
__Table 5a__&nbsp;  European eel. Official commercial landings (tonnes) of yellow 
and silver eel (1908–2023) in `r paste(set1names, paste0("(",set1,")"), collapse = ", ")`.
Empty cell = no data, data not collected, or data not pertinent. The total 
column is the yearly sum for all countries included in tables 5a, 5b, and 5c and 
not just the countries listed in this particular table.
:::

```{r, tab.id = "tab5a", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}


landingsYS |>
  dplyr::select(all_of(c("Year", set1))) |>
  flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  width(1, width = 4.16, "cm") |>
  width(2, width = 13.25, "cm") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(big.mark = ",", digits = 1) |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  flextable::align(align = "right", part = "body") |>
  flextable::align(j = 1, align = "center", part = "body") |>
  flextable::align(align = "center", part = "header") |>
  flextable2ICES()
```

\* Landings from France are incomplete from 2002 to 2010.

<br>

::: {custom-style="Table Caption"}
__Table 5b__&nbsp;  European eel. Official commercial landings (tonnes) of yellow 
and silver eel (1908–2023) in `r paste(set2names, paste0("(",set2,")"), collapse = ", ")`.
Empty cell = no data, data not collected, or data not pertinent. The total 
column is the yearly sum for all countries included in tables 5a, 5b, and 5c and 
not just the countries listed in this particular table.
:::
```{r, tab.id = "tab5b", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}


landingsYS |>
  dplyr::select(all_of(c("Year", set2))) |>
flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  width(1, width = 4.16, "cm") |>
  width(2, width = 13.25, "cm") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
    colformat_double(big.mark = ",", digits = 1) |>
colformat_double(j = 1, big.mark = "", digits = 0) |>
    flextable::align(align = "right", part = "body") |>
    flextable::align(j = 1, align = "center", part = "body") |>
flextable::align(align = "center", part = "header") |>
  flextable2ICES() 
```

<br>

::: {custom-style="Table Caption"}
__Table 5c__&nbsp;  European eel. Official commercial landings (tonnes) of yellow 
and silver eel (1908–2023) in `r paste(set3names, paste0("(",set3,")"), collapse = ", ")`.
Empty cell = no data, data not collected, or data not pertinent. The total 
column is the yearly sum for all countries included in tables 5a, 5b, and 5c and 
not just the countries listed in this particular table.
:::

```{r, tab.id = "tab5c" , echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

landingsYS |>
  dplyr::select(all_of(c("Year", set3, "Total"))) |>
flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  width(1, width = 4.16, "cm") |>
  width(2, width = 13.25, "cm") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
    colformat_double(big.mark = ",", digits = 1) |>
colformat_double(j = 1, big.mark = "", digits = 0) |>
    flextable::align(align = "right", part = "body") |>
    flextable::align(j = 1, align = "center", part = "body") |>
flextable::align(align = "center", part = "header") |>
  flextable2ICES()
```

\* Landings from the Netherlands are incomplete before 2010.

<br>

::: {custom-style="Table Caption"}
__Table 6__&nbsp;  European eel. Recreational landings (tonnes) of glass eels 
(1978–2023) in countries where fisheries exist, i.e. France (FR) and Spain (ES).
Empty cell = no data, data not collected, or data not pertinent.
:::

```{r, tab.id = "tab6",  echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}


filtered_data<-filter_data("landings",
    typ = 6,
    life_stage = "G")%>% dplyr::filter(is.na(eel_missvaluequal))
year<-unique(filtered_data$eel_year)
country<-unique(filtered_data$eel_cou_code)
hty<-unique(filtered_data$eel_hty_code)
grouped_data <-group_data(filtered_data,geo="country",habitat=FALSE,lfs=FALSE,na.rm=TRUE) |>
  mutate(eel_value = eel_value/1000) |>
  pivot_wider(id_cols = all_of("eel_year"),
              names_from = eel_cou_code,
              values_from = eel_value) |>
  dplyr::rename(Year = eel_year) %>%
  mutate(Year = as.character(Year)) %>%
  mutate(Total = rowSums(. |> dplyr::select(!all_of("Year")),
                         na.rm = TRUE) ) |>
  arrange(Year)

grouped_data$Year[nrow(grouped_data)] <- paste0(grouped_data$Year[nrow(grouped_data)], "*")


grouped_data |>
  flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
    colformat_double(big.mark = ",", digits = 1) |>
colformat_double(j = 1, big.mark = "", digits = 0) |>
    flextable::align(align = "right", part = "body")|>
flextable::align(align = "center", part = "header") |>
      flextable::align(j = 1, align = "center", part = "body") |>
  flextable2ICES() 

```

\* Preliminary data

<br>

```{r, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

filtered_data<-filter_data("landings",
    typ = 6,
    life_stage = c("Y","S","YS"))%>% dplyr::filter(is.na(eel_missvaluequal))
year<-unique(filtered_data$eel_year)
country<-unique(filtered_data$eel_cou_code)
hty<-unique(filtered_data$eel_hty_code)

landingsrecYS <-group_data(filtered_data,geo="country",habitat=FALSE,lfs=FALSE,na.rm=TRUE) |>
  mutate(eel_value = eel_value/1000) |>
  pivot_wider(id_cols = all_of("eel_year"),
              names_from = eel_cou_code,
              values_from = eel_value) |>
  dplyr::rename(Year = eel_year) %>%
  mutate(Year = as.character(Year)) %>%
  mutate(Total = rowSums(. |> dplyr::select(!all_of("Year")),
                         na.rm = TRUE) ) |>
  arrange(Year)
landingsrecYS$Year[nrow(landingsrecYS)] <- paste0(landingsrecYS$Year[nrow(landingsrecYS)], "*")


countries <- setdiff(names(landingsrecYS), c("Year", "Total"))
nbcountries <- length(countries)
set1 <- countries[seq_len(round(nbcountries/2))]
set2 <- countries[(round(nbcountries/ 2)+1):nbcountries]

set1names <- country_c$cou_country[match(gsub("\\*", "", set1), country_c$cou_code)]
set2names <- country_c$cou_country[match(gsub("\\*", "", set2), country_c$cou_code)]

```

::: {custom-style="Table Caption"}
__Table 7a__&nbsp;  European eel. Recreational landings (tonnes) of yellow and 
silver eel (1980–2024) in `r paste(set1names, paste0("(",set1,")"), collapse = ", ")`
and Belgium (BE). Countries omitted in tables 7a and 7b include those where 
recreational landings are prohibited and those that have not reported.
:::

```{r, tab.id = "tab7a",  echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}


landingsrecYS |>
  dplyr::select(all_of(c("Year", set1))) |>
  flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(big.mark = ",", digits = 1) |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  flextable::align(align = "right", part = "body") |>
  flextable::align(j = 1, align = "center", part = "body") |>
  flextable::align(align = "center", part = "header") |>
  flextable2ICES() 

```

\* Preliminary data

<br>


::: {custom-style="Table Caption"}
__Table 7b__&nbsp;  European eel. Recreational landings (tonnes) of yellow and 
silver eel (1980–2024) in `r paste(set2names, paste0("(",set2,")"), collapse = ", ")`
and Belgium (BE). Countries omitted in tables 7a and 7b include those where 
recreational landings are prohibited and those that have not reported.
:::

```{r, tab.id = "tab7b", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

landingsrecYS |>
  dplyr::select(all_of(c("Year", set2, "Total"))) |>
  flextable() |>
  bg( bg = "#e8eaea", part = "header") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(big.mark = ",", digits = 1) |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  flextable::align(align = "right", part = "body") |>
  flextable::align(j = 1, align = "center", part = "body") |>
  flextable::align(align = "center", part = "header") |>
  flextable2ICES() 

```

<br>

# Summary of the assessment

::: {custom-style="Table Caption"}
__Table 8__&nbsp;  European eel. Recruitment indices: geometric means (“Value”) of 
estimated (GLM) recruitment for glass eels, with 95% prediction intervals
(“Lower” and “Upper”) in the continental “North Sea” and “Elsewhere Europe”,
and recruitment of yellow eels in Europe. The glass eel GLM (predicting
recruitment as a function of area, year, and site) was fitted to 60 time-series,
comprising either pure glass eels or a mixture of glass eels and yellow eels and 
scaled to the 1960–1979 geometric mean so that values correspond to the
recruitment as a percentage of the 1960–1979 geometric mean. The yellow eel 
GLM (predicting recruitment as a function of year and site) was fitted to 21
yellow eel time-series and scaled to the 1960–1979 geometric mean so that values
correspond to the recruitment as a percentage of the 1960–1979 geometric mean. 
These indices are updated on an annual basis and, as they are presented in 
relative terms, may change the historical values.
:::


```{r, tab.id = "tab8", echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

tab <-
dat_ge |> 
  dplyr::select(all_of(c("year", "area", "p_std_1960_1979_min", "p_std_1960_1979", "p_std_1960_1979_max"))) |>
  dplyr::rename(Lower = p_std_1960_1979_min,
         Value = p_std_1960_1979,
         Upper = p_std_1960_1979_max) |>
  mutate(area = paste(area, "index (%)")) |>
  bind_rows(dat_ye |>
              dplyr::select(all_of(c("year", "yellow_eel_min", "value_std_1960_1979", "yellow_eel_max"))) |>
              mutate(area = "Yellow eel Europe index (%)") |>
              dplyr::rename(Lower = yellow_eel_min,
                     Value = value_std_1960_1979,
                     Upper = yellow_eel_max)) |>
  dplyr::rename(Year = year) |>
  mutate(across(all_of(c("Lower", "Value", "Upper")),
                        ~ .x *100)) |>
  pivot_wider(id_cols = all_of("Year"),
              names_from = c("area"),
              values_from = c("Lower", "Value", "Upper"),
              names_sort = TRUE,
              names_vary = "slowest")  |>
  arrange(Year)

tab$Year[nrow(tab)] <- paste0(tab$Year[nrow(tab)], "*") 

first_header <- c(gsub("^.+_", "", names(tab)))
second_header <- c(gsub("_.+$", "", names(tab)))

flextable(tab) |>
  flextable::add_header_row(values = second_header) |>
  flextable::add_header_row(values = first_header) |>
  flextable::delete_rows(3, "header") |>
  flextable::merge_h(part = "header") |>
  flextable::merge_v(part = "header") |>
  bg( bg = "#e8eaea", part = "header") |>
  border_inner() |>
  border_outer() |>
  autofit() |>
  set_table_properties(width = 1, layout = "fixed") |>
  colformat_double(big.mark = ",", digits = 1) |>
  colformat_double(j = 1, big.mark = "", digits = 0) |>
  flextable::align(align = "right", part = "body") |>
  flextable::align(j = 1, align = "center", part = "body") |>
  flextable::align(align = "center", part = "header") |>
  flextable2ICES() 
```

\* Preliminary data

<br>

# Sources and references
