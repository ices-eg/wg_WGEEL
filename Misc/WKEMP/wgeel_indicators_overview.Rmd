---
title: "wgeel_indicators_overwiew"
author: "none"
date: "27/09/2021"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(RPostgres)
library(sf)
library(getPass)
library(ggforce)
library(ggplot2)
library(flextable)
library(tidyverse)
library(yaml)
cred=read_yaml("../../credentials.yml")
con = dbConnect(Postgres(), dbname=cred$dbname,host=cred$host,port=cred$port,user=cred$user, password=getPass())
load("../../R/shiny_data_visualisation/shiny_dv/data/maps_for_shiny.Rdata")
load("../../R/shiny_data_visualisation/shiny_dv/data/ref_and_eel_data.Rdata")
#emu_c <- st_as_sf(emu_c)
emu_c <- dplyr::filter(emu_c,!endsWith(emu_nameshort,"_o")) 

values=c(RColorBrewer::brewer.pal(12,"Set3"),
    RColorBrewer::brewer.pal(12, "Paired"), 
    RColorBrewer::brewer.pal(8,"Accent"),
    RColorBrewer::brewer.pal(8, "Dark2"))
country_ref=dbGetQuery(con,"select cou_code from ref.tr_country_cou")
color_countries = setNames(values,country_ref$cou_code)

```

# Downloading data

```{r download}
biomass <- dbGetQuery(con,"select e.* from datawg.t_eelstock_eel e  where eel_qal_id in (0,1,2,3,4) and eel_typ_id in (13,14,15)")

mortality <- dbGetQuery(con,"select e.* from datawg.t_eelstock_eel e where eel_qal_id in (0,1,2,3,4) and eel_typ_id in (17,18,19)")


nb_country_emu <- dbGetQuery(con,"select count(distinct eel_cou_code),count(distinct(eel_emu_nameshort)) from datawg.t_eelstock_eel 
                             where eel_typ_id in (13, 14, 15, 17, 18, 19) and eel_datasource='dc_2021'")
```

# Data availability
## General overview
Tables showing the numbers of the range and numbers of years provided for each indicator by each country
```{r data2020}
flextable(biomass %>% 
            mutate(eel_value=ifelse(is.na(eel_value & eel_missvaluequal == "NP"), 0,eel_value)) %>% 
            select(eel_typ_id,
                   eel_year,
                   eel_emu_nameshort,
                   eel_value) %>%
            mutate(eel_typ_id=case_when(eel_typ_id==13~"B0",eel_typ_id==14~"Bbest",eel_typ_id==15~"Bcurrent")) %>%
            na.omit() %>%
            group_by(eel_typ_id,
                     eel_emu_nameshort) %>%
            summarize(minyear=min(eel_year), maxyear=max(eel_year), nb_value=n()) %>%
            mutate(range=paste(minyear, maxyear, sep = "-")) %>%
            select(eel_typ_id, eel_emu_nameshort, nb_value, range) %>%
            arrange(eel_emu_nameshort) %>%
            pivot_wider(names_from=eel_typ_id, values_from=c(range, nb_value),
                        names_glue="{eel_typ_id}_{.value}",
                        names_sort=TRUE)) %>% autofit()
```


for mortality

```{r mortadata}
  

flextable(mortality %>% 
            mutate(eel_value=ifelse(is.na(eel_value & eel_missvaluequal == "NP"), 0,eel_value)) %>% 
            select(eel_typ_id,
                   eel_year,
                   eel_emu_nameshort,
                   eel_value) %>%
            mutate(eel_typ_id=case_when(eel_typ_id==17~"sumA",eel_typ_id==18~"sumF",eel_typ_id==19~"sumH")) %>%
            na.omit() %>%
            group_by(eel_typ_id,
                     eel_emu_nameshort) %>%
            summarize(minyear=min(eel_year), maxyear=max(eel_year), nb_value=n()) %>%
            mutate(range=paste(minyear, maxyear, sep = "-")) %>%
            select(eel_typ_id, eel_emu_nameshort, nb_value, range) %>%
            arrange(eel_emu_nameshort) %>%
            pivot_wider(names_from=eel_typ_id, values_from=c(range, nb_value),
                        names_glue="{eel_typ_id}_{.value}",
                        names_sort=TRUE)) %>% autofit()
  
        
          
          
```


```{r notans}
sort(country_p$cou_country[! country_p$cou_code %in% c(biomass$eel_cou_code , mortality$eel_cou_code)]) 
```

## Spatial coverage
Maps showings data avaibility. The symbol indicates wether the country have provided estimates for at least one (whatever year), two , three distinct indicators.
```{r indicatorsmaps}
data_avail = rbind.data.frame(mortality,biomass) %>%
  filter(!(is.na(eel_value) & eel_missvaluequal!="NP")) %>%
  group_by(eel_emu_nameshort) %>%
  summarize(b0=sum(eel_typ_id==13)>0,
         bbest=sum(eel_typ_id==14)>0,
         bcurrent=sum(eel_typ_id==15)>0,
         suma=sum(eel_typ_id==17)>0,
         sumf=sum(eel_typ_id==18)>0,
         sumh=sum(eel_typ_id==19)>0)
data_avail <- merge(emu_c, data_avail, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
data_avail<- st_transform(data_avail, crs=3035)
data_avail$x <-st_coordinates(data_avail)[,1]
data_avail$y <-st_coordinates(data_avail)[,2]
data_avail$x[data_avail$emu_cou_code=="NO"] = 4172612.3
data_avail$y[data_avail$emu_cou_code=="NO"] = 4111023.3
data_avail<- data_avail %>%
  mutate(bsummary=coalesce(b0+bbest+bcurrent, 0),
         mortsummary=coalesce(suma+sumf+sumh,0),
         responded=ifelse(is.na(bsummary) & is.na(mortsummary), FALSE, TRUE))


ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(bsummary)),shape=21)+
  scale_fill_viridis_d("Biomass indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")

ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(mortsummary)),shape=21)+
  scale_fill_viridis_d("Mortality indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")

data_avail =data_avail %>% select(emu_nameshort,x,y,bsummary,responded,mortsummary,geometry) %>%
  pivot_longer(cols=ends_with("summary"),names_to="indicator",values_to="nb")

ggplot(st_transform(country_p,crs=3035)) + geom_sf(fill=NA)+theme_bw()+
  geom_point(data=data_avail,aes(x=x,y=y,fill=as.factor(nb)),shape=21)+
  scale_fill_viridis_d("Number of indicators",labels=c("none","one","two","three"))+
  xlab("")+ylab("")+facet_wrap(~indicator)

#ggsave(filename="/tmp/maps.png",width=16/2.54,height=10/2.54)
```

## Habitat coverage
This year for the first time, we asked aggregated data at the EMU scale, but asked for habitat coverage within indicator.

```{r habitatcoverage}
biomass <- dbGetQuery(con,"select * from datawg.t_eelstock_eel e  left join datawg.t_eelstock_eel_percent on eel_id=percent_id where eel_qal_id=1 and eel_typ_id in (13,14,15)")

mortality <- dbGetQuery(con,"select * from datawg.t_eelstock_eel e left join datawg.t_eelstock_eel_percent on eel_id=percent_id where eel_qal_id=1 and eel_typ_id in (17,18,19)")



biomass_long <- biomass%>%
  filter(!is.na(eel_value)) %>%
  select(eel_year,eel_typ_id,eel_emu_nameshort,perc_mo,perc_f,perc_c,perc_t) %>%
  pivot_longer(cols=c(perc_mo,perc_f,perc_t,perc_c), 
               names_to="habitat", values_to="perc") %>%
  mutate(habitat=toupper(gsub("perc_","",habitat)))%>%
  mutate(type="biomass",
         eel_typ_id=case_when(eel_typ_id==13~"B0",eel_typ_id==14~"Bbest",eel_typ_id==15~"Bcurrent"))

mortality_long <-mortality%>%
  filter(!is.na(eel_value)) %>%
  select(eel_year,eel_typ_id,eel_emu_nameshort,perc_mo,perc_f,perc_c,perc_t) %>%
  pivot_longer(cols=c(perc_mo,perc_f,perc_t,perc_c), 
               names_to="habitat", values_to="perc") %>%
  mutate(habitat=toupper(gsub("perc_","",habitat))) %>%
  mutate(type="mortality",
         eel_typ_id=case_when(eel_typ_id==17~"sumA",eel_typ_id==18~"sumF",eel_typ_id==19~"sumH"))

indicator <- biomass_long %>%
  bind_rows(mortality_long) %>%
  filter(perc >= 0)

flextable(indicator %>%
  group_by(type,habitat) %>%
  summarize(freq100=round(sum(perc==100)/n()*100),
            freq0=round(sum(perc==0)/n()*100)) %>%
  pivot_wider(names_from=habitat,values_from=c(freq0,freq100))) %>% autofit()
```
Marine open and coastal never accounted for. Significant part of transitional waters not accounted for.

# Maps of indicators
Values averages from 2018 to 2020 (3 years)

## per emu


```{r rasta}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
# indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# indicator = st_transform(indicator,crs=3035)
# indicator$x <-st_coordinates(indicator)[,1]
# indicator$y <-st_coordinates(indicator)[,2]
# indicator$btarget <- .4*indicator$b0
# indicator$bscaled <- indicator$bcurrent/indicator$b0
# prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
# prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# # indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
#  indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# # indicator$bbest <- scales::rescale(indicator$bbest,to=c(40190.79,200000.00),from=c(661,10400000))
# # indicator$b0 <- scales::rescale(indicator$b0,to=c(40190.79,200000.00),from=c(661,10400000))
# 
# # indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# # indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# # indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$suma <- indicator$suma /.92*20000
# indicator$sumf <- indicator$sumf /.92*20000
# indicator$sumh <- indicator$sumh /.92*20000
# 
# 
# legend <- data.frame(indicator=c("sumA","sumF"))
# 
# # indicator <- indicator %>%
# #   select(-sumh) %>%
# #   pivot_longer(cols=c(suma,sumf,b0,btarget,bcurrent,bbest),names_to="indicator",values_to="r") %>%
# #   mutate(start=ifelse(startsWith(indicator,"b"),pi,0),
# #          end=ifelse(startsWith(indicator,"b"),2*pi,pi),
# #          fill=case_when(indicator=="b0" ~ "grey",
# #                         indicator=="bcurrent" ~ "green",
# #                         indicator=="bbest" ~ "orange",
# #                         indicator=="btarget" ~ "red",
# #                         indicator=="sumf" ~ "yellow",
# #                         indicator=="suma" ~ "blue"),
# #          alpha=ifelse(indicator %in% c("b0","suma"),
# #                       1,
# #                       0)) %>%
# #   arrange(desc(r))
# #   
# # 
# # 
# # indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# # indicator = st_transform(indicator,crs=3035)
# # indicator$x <-st_coordinates(indicator)[,1]
# # indicator$y <-st_coordinates(indicator)[,2]
# 
# ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA)+theme_bw()+
#   xlim(2618000,5286000)+ylim(1700000,4560000)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
# #                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
# #                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
# #                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
# #  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
# #                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
#    geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                    end = 2*pi, fill = bscaled),col=NA,alpha=1)+
#   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
#                    end = pi),fill=NA,col="blue")+
#   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
#                    end = pi ),fill=NA,alpha=1,col="yellow")+
#   
#   xlab("")+ylab("") + 
#   geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
#                    end = 2*pi), fill = NA,col="black")+
#   geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
#             size=1,hjust="left")+
#   geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =3800000, r0 = 0, r = 20000, start =0,
#                    end = pi), fill = NA,col="black")+
#   geom_text(data=scalesb,aes(x=3000000, y=3800000+20000,label="0.92~year^{-1}" ),
#             size=1,hjust="right", parse=TRUE)+
#   geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+
#    scale_color_manual("",values=c("sumF" = "yellow",
#                           "sumA" = "blue"))+
#   scale_fill_viridis_c("Bcurrent/B0")
#   # scale_alpha_manual("",values=c("B0" = 1,
#   #                        "Bcurrent" = .6,
#   #                        "Bbest"= .6,
#   #                        "Btarget" = .6,
#   #                        "sumF" = 1,
#   #                        "sumA" = 1))
# 
# ggsave(filename="/tmp/maps.png",width=16/2.54,height=10/2.54)


```

### biomass
```{r biomassmap}
indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
 indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
# indicator$bbest <- scales::rescale(indicator$bbest,to=c(40190.79,200000.00),from=c(661,10400000))
# indicator$b0 <- scales::rescale(indicator$b0,to=c(40190.79,200000.00),from=c(661,10400000))

# indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
indicator$suma <- indicator$suma /.92*20000
indicator$sumf <- indicator$sumf /.92*20000
indicator$sumh <- indicator$sumh /.92*20000

indicator$x[indicator$eel_cou_code=="NO"] = 4172612.3
indicator$y[indicator$eel_cou_code=="NO"] = 4111023.3

# indicator <- indicator %>%
#   select(-sumh) %>%
#   pivot_longer(cols=c(suma,sumf,b0,btarget,bcurrent,bbest),names_to="indicator",values_to="r") %>%
#   mutate(start=ifelse(startsWith(indicator,"b"),pi,0),
#          end=ifelse(startsWith(indicator,"b"),2*pi,pi),
#          fill=case_when(indicator=="b0" ~ "grey",
#                         indicator=="bcurrent" ~ "green",
#                         indicator=="bbest" ~ "orange",
#                         indicator=="btarget" ~ "red",
#                         indicator=="sumf" ~ "yellow",
#                         indicator=="suma" ~ "blue"),
#          alpha=ifelse(indicator %in% c("b0","suma"),
#                       1,
#                       0)) %>%
#   arrange(desc(r))
#   
# 
# 
# indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort")
# indicator = st_transform(indicator,crs=3035)
# indicator$x <-st_coordinates(indicator)[,1]
# indicator$y <-st_coordinates(indicator)[,2]

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
#                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
#                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
#                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = 0,
                   end = 2*pi, fill = bscaled),col=NA,alpha=1)+
  
  xlab("")+ylab("") + 
  geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
                   end = 2*pi), fill = NA,col="black")+
  geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
            size=2,hjust="left")+
  geom_point(data=indicator %>%
               filter(is.na(bcurrent)),
             aes(x=x,y=y),pch="x")+
  scale_fill_viridis_c(expression(B[current]/B[0]))
  # scale_alpha_manual("",values=c("B0" = 1,
  #                        "Bcurrent" = .6,
  #                        "Bbest"= .6,
  #                        "Btarget" = .6,
  #                        "sumF" = 1,
  #                        "sumA" = 1))

#ggsave(filename="C:/Users/pohlmann/Desktop/Home_Office/ICES/WKEPEMP3/Graphs/maps_biomass.png",width=16/2.54,height=10/2.54)
```

### mortality


```{r mortalitymap}
indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_emu where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- merge(emu_c, indicator, by.x="emu_nameshort",by.y="eel_emu_nameshort",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
indicator$x[indicator$eel_cou_code=="NO"] = 4172612.3
indicator$y[indicator$eel_cou_code=="NO"] = 4111023.3
# indicator$bcurrent <- log(indicator$bcurrent)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$bbest <- log(indicator$bbest)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$b0 <- log(indicator$b0)/log(max(indicator$b0,na.rm=TRUE))*100000
# indicator$suma <- indicator$suma /.92*40000
# indicator$sumf <- indicator$sumf /.92*40000
# indicator$sumh <- indicator$sumh /.92*40000
prettyscale <- c(0,.92)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40000,200000),from=c(0,max(indicator$suma,na.rm=TRUE)))


indicator$sumfsuma <- indicator$sumf/indicator$suma

indicator$suma <- scales::rescale(indicator$suma,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

scalesm <-data.frame(m=prettyscale,mscale=prettyscale_scaled,y0=c(4200000,4400000))

legend <- data.frame(indicator=c("sumA","sumF"))

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
                   end = 2*pi,fill=sumfsuma),size=.2,col=NA)+
  # geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
  #                  end = 2*pi ),size=.2,fill=NA,col="yellow")+
  xlab("")+ylab("") + 
  geom_point(data=indicator %>%
               filter(is.na(suma) & is.na(sumf)),
             aes(x=x,y=y),pch="x")+
    geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =3800000, r0 = 0, r = 40000, start =0,
                   end = pi),size=.2, fill = NA,col="black")+
    geom_arc_bar(data=scalesm,aes(x0 = 3008000, y0 =y0, r0 = 0, r = mscale, start =0,
                   end = pi), fill = NA,col="black")+
  geom_text(data=scalesm,aes(x=3000000, y=y0+mscale,label=paste0(m,"~year^{-1}")),
            size=1,hjust="right", parse=TRUE)+
#    geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+

     # scale_color_manual("",values=c("sumF" = "yellow",
     #                      "sumA" = "blue"))
  scale_fill_viridis_c(expression(paste(Sigma,"F")/paste(Sigma,"A")))


#ggsave(filename="/tmp/maps_mortality.png",width=16/2.54,height=10/2.54)
```



## per country
Here, biomasses are summed over available EMUs and mortality are average (weighted averages based on bbest)

### biomass
```{r biomassmapcountry}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_country where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- precodata_country %>%
  filter(eel_year >=2018) %>%
  group_by(eel_cou_code) %>%
  summarize(b0=mean(b0,na.rm=TRUE),
            bcurrent=mean(bcurrent,na.rm=TRUE),
            bcurrent_b0_emu=mean(ratio_bcurrent_b0,na.rm=TRUE))
indicator <- merge(country_c, indicator, by.x="cou_code",by.y="eel_cou_code",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$x[indicator$cou_code=="NO"] = 4172612.3
indicator$y[indicator$cou_code=="NO"] = 4111023.3

indicator$btarget <- .4*indicator$b0
indicator$bscaled <- indicator$bcurrent/indicator$b0
prettyscale <- pretty(range(indicator$bcurrent,na.rm=TRUE),n=2)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))
scalesb <-data.frame(b=prettyscale,bscale=prettyscale_scaled)
# indicator$btarget <- scales::rescale(indicator$btarget,to=c(40190.79,200000.00),from=c(661,10400000))
 indicator$bcurrent <- scales::rescale(indicator$bcurrent,to=c(40190.79,200000.00),from=c(661,max(indicator$bcurrent,na.rm=TRUE)))

 

 
 
ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = b0, start =pi,
#                   end = 2*pi), fill = "grey",col=NA,alpha=1)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = btarget, start =pi,
#                   end = 2*pi), fill = "red",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bbest, start = pi,
#                   end = 2*pi ), fill = "orange",col=NA,alpha=.6)+
#  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = pi,
#                   end = 2*pi), fill = "green",col=NA,alpha=.6)+
   geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = bcurrent, start = 0,
                   end = 2*pi, fill = bcurrent_b0_emu),col=NA,alpha=1)+
  
  xlab("")+ylab("") + 
  geom_arc_bar(data=scalesb,aes(x0 = 3008000, y0 =4200000, r0 = 0, r = bscale, start =pi,
                   end = 2*pi), fill = NA,col="black")+
  geom_text(data=scalesb,aes(x=3050000, y=4200000+bscale,label=paste0(b/1e3,"t")),
            size=1,hjust="left")+
  geom_point(data=indicator %>%
               filter(is.na(bcurrent)),
             aes(x=x,y=y),pch="x")+
  scale_fill_viridis_c(expression(B[current]/B[0]))
  # scale_alpha_manual("",values=c("B0" = 1,
  #                        "Bcurrent" = .6,
  #                        "Bbest"= .6,
  #                        "Btarget" = .6,
  #                        "sumF" = 1,
  #                        "sumA" = 1))

#ggsave(filename="/tmp/maps_biomass_country.png",width=16/2.54,height=10/2.54)
```

### mortality


```{r mortalitymapcountry}
# indicator <- dbGetQuery(con,"select eel_cou_code,eel_emu_nameshort, avg(b0)b0,avg(bbest)bbest,avg(bcurrent)bcurrent, avg(suma)suma,avg(sumf)sumf,avg(sumh) sumh from datawg.precodata_country where eel_year>=2018 group by eel_cou_code,eel_emu_nameshort")
indicator <- precodata_country %>%
  filter(eel_year >=2018) %>%
  group_by(eel_cou_code) %>%
  summarize(suma=mean(suma,na.rm=TRUE),
            sumf=mean(sumf,na.rm=TRUE),
            sumfsuma_emu=mean(ratio_sumfsuma,na.rm=TRUE))
indicator <- merge(country_c, indicator, by.x="cou_code",by.y="eel_cou_code",all.x=TRUE)
indicator = st_transform(indicator,crs=3035)
indicator$x <-st_coordinates(indicator)[,1]
indicator$y <-st_coordinates(indicator)[,2]
indicator$x[indicator$cou_code=="NO"] = 4172612.3
indicator$y[indicator$cou_code=="NO"] = 4111023.3

prettyscale <- c(0,.92)
prettyscale_scaled <- scales::rescale(prettyscale,to=c(40000,200000),from=c(0,max(indicator$suma,na.rm=TRUE)))

indicator$sumf <- scales::rescale(indicator$sumf,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

indicator$suma <- scales::rescale(indicator$suma,to=c(40000,200000), from=c(0,max(indicator$suma,na.rm=TRUE)))

scalesm <-data.frame(m=prettyscale,mscale=prettyscale_scaled,y0=c(4200000,4500000))



legend <- data.frame(indicator=c("sumA","sumF"))

ggplot(st_transform(country_p,3035)) + geom_sf(fill=NA,size=.1)+theme_bw()+
  geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = suma, start =0,
                   end = 2*pi,fill=sumfsuma_emu),size=.2,col=NA)+
  # geom_arc_bar(data=indicator,aes(x0 = x, y0 = y, r0 = 0, r = sumf, start = 0,
  #                  end = 2*pi ),size=.2,fill=NA,col="yellow")+
  xlab("")+ylab("") + 
  geom_point(data=indicator %>%
               filter(is.na(suma) & is.na(sumf)),
             aes(x=x,y=y),pch="x")+
    geom_arc_bar(data=scalesm,aes(x0 = 3008000, y0 =y0, r0 = 0, r = mscale, start =0,
                   end = pi), fill = NA,col="black")+
  geom_text(data=scalesm,aes(x=3000000, y=y0+mscale,label=paste0(m,"~year^{-1}")),
            size=1,hjust="right", parse=TRUE)+
#    geom_rect(data=legend,aes(col=indicator,xmin=0,ymin=0,xmax=0,ymax=0),fill=NA)+

     # scale_color_manual("",values=c("sumF" = "yellow",
     #                      "sumA" = "blue"))
  scale_fill_viridis_c(expression(paste(Sigma,"F")/paste(Sigma,"A")))


#ggsave(filename="/tmp/maps_mortality_country.png",width=16/2.54,height=10/2.54)
```



# Time trends
## Biomass visualisation
Each line represents an EMU.

```{r trendbiomass}
indicator <- dbGetQuery(con,"select eel_year,eel_cou_code,eel_emu_nameshort, b0,bbest,bcurrent, suma,sumf, sumh from datawg.precodata_emu")
indicator<- indicator %>%
  mutate(eel_cou_code=ifelse(eel_cou_code == substr(eel_emu_nameshort,1,2),
                             eel_cou_code,
                             "INT")) %>%
  filter(eel_cou_code!="IE" | eel_year !=2008)


ggplot(indicator %>% filter(!is.na(bcurrent/b0)),aes(x=eel_year,y=bcurrent/b0)) +
  geom_hline(yintercept=.4,col="red")+
  geom_line(aes(col=eel_cou_code,group=eel_emu_nameshort))+
#  scale_y_log10()+
  scale_color_manual("country",values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)],)+
  guides(lty=FALSE,col=FALSE)+ #geom_hline(yintercept=1)+
#  scale_y_sqrt()+
  
theme_bw() + ylab(expression(B[current]/B[0]))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")
  



```

## Mortalities visualization

```{r trendmorta}
indicator <- dbGetQuery(con,"select eel_year,eel_cou_code,eel_emu_nameshort, b0,bbest,bcurrent, suma,sumf, sumh from datawg.precodata_emu")
indicator<- indicator %>%
  mutate(eel_cou_code=ifelse(eel_cou_code == substr(eel_emu_nameshort,1,2),
                             eel_cou_code,
                             "INT")) %>%
  filter(eel_cou_code!="IE" | eel_year !=2008)



ggplot(indicator %>% filter(!is.na(suma)),aes(x=eel_year,y=suma))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"A")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")

color_countries = c(color_countries,"INT"="#ff5733")            

ggplot(indicator %>% filter(!is.na(sumf)),aes(x=eel_year,y=sumf))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"F")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code, drop=TRUE,scales="free_y")



ggplot(indicator %>% filter(!is.na(sumh)),aes(x=eel_year,y=sumh))+
  geom_hline(yintercept=0.92,col="red")+
  geom_line(aes(group=eel_emu_nameshort,col=eel_cou_code))+
  scale_color_manual(values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)])+
  guides(lty=FALSE, col=FALSE)+
#  scale_y_sqrt()+
  theme_bw() + ylab(expression(paste(Sigma,"H")))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code, drop=TRUE,scales="free_y") 


```

```{r calculate_b0_adj}
library(Kendall)
#source("readingAnnex13.R") run this if you don't have Rdata below
load( file=file.path(getwd(),"data_dependencies","annex13.Rdata")) # annexes13_method,annexes13_traceability,annexes13_management,

eu_cou_codes=c("AT",	"BE",	"BG",	"HR",	"CY",	"CZ",	"DK",	"EE",	"FI",	"FR",	"DE",	"GR",	"HU",	"IE",	"IT",	"LV",	"LT",	"LU",	"MT",	"NL",	"PL",	"PT",	"RO",	"SK",	"SI",	"ES",	"SE",	"GB")

emu_sea= emu_p %>%
  filter(emu_cou_code %in% eu_cou_codes) %>%
  mutate(rec_zone = ifelse(emu_cou_code %in% c("NL","DK","NO","BE","LU", "CZ","SK") |
                             emu_nameshort %in% c("FR_Rhin","FR_Meus","GB_Tham","GB_Angl","GB_Humb","GB_Nort","GB_Solw",
                                                  "DE_Ems","DE_Wese","DE_Elbe","DE_Rhei","DE_Eide","DE_Maas") ,
                           "NS", 
                           ifelse(emu_cou_code %in% c("EE","FI","SE","LV","LT","AX", "PL","DE"),
                                  "BA",
                                  "EE")))


mor_wise = annexes13_method %>% select(emu_nameshort,mortality_wise)
mor_wise = merge(emu_sea %>% st_drop_geometry(),mor_wise)
mor_wise <- mor_wise %>% mutate(cohort_wise=grepl("ohort",mortality_wise)) %>%
  mutate(emu_nameshort = ifelse(emu_nameshort == "NL_Neth","NL_total",emu_nameshort))
load("../../R/shiny_data_visualisation/shiny_dv/data/recruitment/dat_ge.Rdata")
load("../../R/shiny_data_visualisation/shiny_dv/data/recruitment/dat_ye.Rdata")



estimate_b0 = function(emu, year, mor_wise,precodata){
  mod = switch(unique(mor_wise$rec_zone[mor_wise$emu_nameshort == emu]),
               "EE" = dat_ge %>% filter (area == "Elsewhere Europe"),
               "NS" = dat_ge %>% filter (area == "North Sea"),
               "BA" = dat_ye)
  if ("value_std_1960_1979" %in% names(mod)){
    Rcurrent <- mean(mod$value_std_1960_1979[mod$year %in% ((year-4):year)])
  } else {
    Rcurrent <- mean(mod$p_std_1960_1979[mod$year %in% ((year-4):year)])
  }
  if (unique(mor_wise$cohort_wise[mor_wise$emu_nameshort==emu]))
    Rcurrent <- switch(mor_wise$rec_zone[mor_wise$emu_nameshort == emu],
                       "EE" = mean(mod$p_std_1960_1979[mod$year %in% ((year-12):(year-7))]),
                       "NS" = mean(mod$p_std_1960_1979[mod$year %in% ((year-17):(year-12))]),
                       "BA" = mean(mod$value_std_1960_1979[mod$year %in% ((year-22):(year-17))]))
  precodata$bbest[precodata$eel_emu_nameshort==emu & precodata$eel_year==year] / Rcurrent
}

indicator_sub <- indicator %>%
  filter(eel_emu_nameshort %in% unique(mor_wise$emu_nameshort))
indicator_sub$b0_adj = mapply(estimate_b0,indicator_sub$eel_emu_nameshort, indicator_sub$eel_year,
                                MoreArgs=list(mor_wise=mor_wise,precodata=indicator_sub))

options(scipen = 999)
indicator <- indicator %>% left_join(indicator_sub %>% select(eel_year, eel_emu_nameshort, b0_adj), by = c("eel_year", "eel_emu_nameshort"))



```

## B0_adjusted visualisation

```{r plot B0_adj_and_ratio}

ggplot(indicator %>% filter(!is.na(b0_adj)),aes(x=eel_year,y=b0_adj/1000000)) +
  geom_hline(yintercept=.4,col="red")+
  geom_line(aes(col=eel_cou_code,group=eel_emu_nameshort))+
#  scale_y_log10()+
  scale_color_manual("country",values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)],)+
  guides(lty=FALSE,col=FALSE)+ #geom_hline(yintercept=1)+
#  scale_y_sqrt()+
theme_bw() + ylab(expression(B[0-adj]~"in mio"))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")

ggplot(indicator %>% filter(!is.na(bcurrent/b0_adj)),aes(x=eel_year,y=bcurrent/b0_adj)) +
  geom_hline(yintercept=.4,col="red")+
  geom_line(aes(col=eel_cou_code,group=eel_emu_nameshort))+
#  scale_y_log10()+
  scale_color_manual("country",values=color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)],)+
  guides(lty=FALSE,col=FALSE)+ #geom_hline(yintercept=1)+
#  scale_y_sqrt()+
theme_bw() + ylab(expression(B[current]/B[0-adj]))+xlab("") + xlim(2007,2020)+facet_wrap(~eel_cou_code,drop=TRUE,scales="free_y")
```


## Data availability

```{r visualize_datagaps}

require(naniar)
indicator_vis <- expand.grid(eel_emu_nameshort = unique(indicator$eel_emu_nameshort),
                             eel_year = seq(2006, 2021, by = 1)) %>%
                                        left_join(indicator %>% select(eel_emu_nameshort, sumh, sumf, suma, bcurrent, bbest, b0, eel_year), by = c("eel_emu_nameshort" = "eel_emu_nameshort", "eel_year" = "eel_year"))

gg_miss_fct(x = indicator_vis %>% select(-eel_emu_nameshort), fct = eel_year)

ggplot(indicator_vis %>% select(eel_emu_nameshort, eel_year, b0) %>%
  mutate(b0 = ifelse(is.na(b0), "abscent", "present")), aes(eel_emu_nameshort, eel_year, fill = b0)) +
  geom_tile() +
  scale_fill_manual(values=c("yellow2", "dark blue"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = -0.001)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_blank(), legend.position = "bottom")+
  theme(legend.title = element_blank())+
  labs(x = "EMU", y = "year") +
  ggtitle(expression("B"["0"]))

ggplot(indicator_vis %>% select(eel_emu_nameshort, eel_year, bcurrent) %>%
  mutate(bcurrent = ifelse(is.na(bcurrent), "abscent", "present")), aes(eel_emu_nameshort, eel_year, fill = bcurrent)) +
  geom_tile() +
  scale_fill_manual(values=c("yellow2", "dark blue"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = -0.001)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_blank(), legend.position = "bottom")+
  theme(legend.title = element_blank())+
  labs(x = "EMU", y = "year") +
  ggtitle(expression("B"["current"]))

ggplot(indicator_vis %>% select(eel_emu_nameshort, eel_year, suma) %>%
  mutate(suma = ifelse(is.na(suma), "abscent", "present")), aes(eel_emu_nameshort, eel_year, fill = suma)) +
  geom_tile() +
  scale_fill_manual(values=c("yellow2", "dark blue"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = -0.001)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_blank(), legend.position = "bottom")+
  theme(legend.title = element_blank())+
  labs(x = "EMU", y = "year") +
  ggtitle("\u03A3A")

ggplot(indicator_vis %>% select(eel_emu_nameshort, eel_year, sumf) %>%
  mutate(sumf = ifelse(is.na(sumf), "abscent", "present")), aes(eel_emu_nameshort, eel_year, fill = sumf)) +
  geom_tile() +
  scale_fill_manual(values=c("yellow2", "dark blue"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = -0.001)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_blank(), legend.position = "bottom")+
  theme(legend.title = element_blank())+
  labs(x = "EMU", y = "year") +
  ggtitle("\u03A3F")

ggplot(indicator_vis %>% select(eel_emu_nameshort, eel_year, suma) %>%
  mutate(suma = ifelse(is.na(suma), "abscent", "present")), aes(eel_emu_nameshort, eel_year, fill = suma)) +
  geom_tile() +
  scale_fill_manual(values=c("yellow2", "dark blue"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = -0.001)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_blank(), legend.position = "bottom")+
  theme(legend.title = element_blank())+
  labs(x = "EMU", y = "year") +
  ggtitle("\u03A3H")



```

Tab XX Summary of implementation progress and related effects in all reporting EMUs.

```{r produce_Kendall_table}


### Kendall_test biomass & Formatting of biomass tables

invisible(capture.output(Kendall_bio_b0 <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  mutate(ratio = bcurrent/b0) %>%
                  filter(eel_year >= 2007) %>%
                  select(eel_emu_nameshort, eel_year, ratio) %>%
                  drop_na(ratio)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = ratio) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_bio_b0_adj <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                      mutate(ratio = bcurrent/b0_adj) %>%
                      filter(eel_year >= 2007) %>%
                      select(eel_emu_nameshort, eel_year, ratio) %>%
                      drop_na(ratio)%>%
                      group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                      pivot_wider(names_from = eel_emu_nameshort, values_from = ratio) %>%
                      arrange(eel_year) %>%
                      select(-eel_year), 
                      function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

Kendall_b0_tab <-  indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2007 & !is.na(b0) & !is.na(bcurrent)) %>% 
                    mutate(ratio_b0 = bcurrent/b0) %>%
                    mutate(Period_b0 = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_b0 = length(ratio_b0[!is.na(ratio_b0)]),
                      Esc_perc_b0_initial = round(ratio_b0[which.min(eel_year)], 3),
                      Esc_perc_b0_current = round(ratio_b0[which.max(eel_year)], 3),
                      Delta_b0 = ratio_b0[which.max(eel_year)] - ratio_b0[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period_b0, n_b0, Esc_perc_b0_initial, Esc_perc_b0_current, Delta_b0) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_bio_b0, by = "eel_emu_nameshort") %>%
                    rename(p_b0 = sl,
                      Tau_b0 = tau,
                      Denominator_b0 = D,
                      Score_b0 = S,
                      VarScore_b0 = varS) %>%
                    mutate(Delta_b0 = round(Delta_b0, 3),
                      p_b0 = round(p_b0, 3),
                      Tau_b0 = round(Tau_b0, 3),
                      Denominator_b0 = round(Denominator_b0, 0),
                      VarScore_b0 = round(VarScore_b0, 3)) #%>%
                     

Kendall_b0_adj_tab <-  indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(b0_adj > 0 & eel_year >= 2007 & !is.na(b0_adj) & !is.na(bcurrent)) %>% 
                    mutate(ratio_b0_adj = bcurrent/b0_adj) %>%
                    mutate(Period_b0_adj = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_b0_adj = length(ratio_b0_adj[!is.na(ratio_b0_adj)]),
                      Esc_perc_b0_adj_initial = round(ratio_b0_adj[which.min(eel_year)], 3),
                      Esc_perc_b0_adj_current = round(ratio_b0_adj[which.max(eel_year)], 3),
                      Delta_b0_adj = ratio_b0_adj[which.max(eel_year)] - ratio_b0_adj[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period_b0_adj, n_b0_adj, Esc_perc_b0_adj_initial, Esc_perc_b0_adj_current, Delta_b0_adj) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_bio_b0_adj, by = "eel_emu_nameshort") %>%
                    rename(p_b0_adj = sl,
                      Tau_b0_adj = tau,
                      Denominator_b0_adj = D,
                      Score_b0_adj = S,
                      VarScore_b0_adj = varS) %>%
                    mutate(Delta_b0_adj = round(Delta_b0_adj, 3),
                      p_b0_adj = round(p_b0_adj, 3),
                      Tau_b0_adj = round(Tau_b0_adj, 3),
                      Denominator_b0_adj = round(Denominator_b0_adj, 0),
                      VarScore_b0_adj = round(VarScore_b0_adj, 3))


###Kendall Test for mortalities and formatting of tables

invisible(capture.output(Kendall_suma <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2007) %>%
                  select(eel_emu_nameshort, eel_year, suma) %>%
                  drop_na(suma)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = suma) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_sumf <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2007) %>%
                  select(eel_emu_nameshort, eel_year, sumf) %>%
                  drop_na(sumf)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = sumf) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

invisible(capture.output(Kendall_sumh <- rownames_to_column(as.data.frame(t(as.data.frame(lapply(indicator %>%
                  filter(eel_year >= 2007) %>%
                  select(eel_emu_nameshort, eel_year, sumh) %>%
                  drop_na(sumh)%>%
                  group_by(eel_emu_nameshort) %>% filter(n()>= 5) %>% ungroup() %>%
                  pivot_wider(names_from = eel_emu_nameshort, values_from = sumh) %>%
                  arrange(eel_year) %>%
                  select(-eel_year), 
                  function(y) unlist (MannKendall(y)))))), "eel_emu_nameshort")))

Kendall_mort_tab_a <- indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2007 & !is.na(suma)) %>%
                    mutate(Period_suma = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_suma = length(suma),
                      suma_initial = round(suma[which.min(eel_year)], 3),
                      suma_current = round(suma[which.max(eel_year)], 3),
                      Delta_suma = suma[which.max(eel_year)] - suma[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period_suma, suma_initial, suma_current,  n_suma, Delta_suma) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_suma, by = "eel_emu_nameshort") %>%
                    rename(p_suma = sl,
                      Tau_suma = tau,
                      Denominator_suma = D,
                      Score_suma = S,
                      VarScore_suma = varS) %>%
                    mutate(Delta_suma = round(Delta_suma, 3),
                      p_suma = round(p_suma, 3),
                      Tau_suma = round(Tau_suma, 3),
                      Denominator_suma = round(Denominator_suma, 0),
                      VarScore_suma = round(VarScore_suma, 3)) 

Kendall_mort_tab_f <- indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2007 & !is.na(sumf)) %>%
                    mutate(Period_sumf = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_sumf = length(sumf),
                      sumf_initial = round(sumf[which.min(eel_year)], 3),
                      sumf_current = round(sumf[which.max(eel_year)], 3),
                      Delta_sumf = sumf[which.max(eel_year)] - sumf[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period_sumf, sumf_initial, sumf_current,  n_sumf, Delta_sumf) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_sumf, by = "eel_emu_nameshort") %>%
                    rename(p_sumf = sl,
                      Tau_sumf = tau,
                      Denominator_sumf = D,
                      Score_sumf = S,
                      VarScore_sumf = varS) %>%
                    mutate(Delta_sumf = round(Delta_sumf, 3),
                      p_sumf = round(p_sumf, 3),
                      Tau_sumf = round(Tau_sumf, 3),
                      Denominator_sumf = round(Denominator_sumf, 0),
                      VarScore_sumf = round(VarScore_sumf, 3))

Kendall_mort_tab_h <- indicator %>%
                    group_by(eel_emu_nameshort) %>%
                    filter(eel_year >= 2007 & !is.na(sumh)) %>%
                    mutate(Period_sumh = paste(min(eel_year), max(eel_year), sep = "-"),
                      n_sumh = length(sumh),
                      sumh_initial = round(sumh[which.min(eel_year)], 3),
                      sumh_current = round(sumh[which.max(eel_year)], 3),
                      Delta_sumh = sumh[which.max(eel_year)] - sumh[which.min(eel_year)]) %>%
                    filter(eel_year == max(eel_year) | eel_year == min(eel_year)) %>%
                    select(eel_emu_nameshort, Period_sumh, sumh_initial, sumh_current,  n_sumh, Delta_sumh) %>%
                    unique() %>%
                    ungroup() %>%
                    arrange(eel_emu_nameshort) %>%
                    left_join(Kendall_sumh, by = "eel_emu_nameshort") %>%
                    rename(p_sumh = sl,
                      Tau_sumh = tau,
                      Denominator_sumh = D,
                      Score_sumh = S,
                      VarScore_sumh = varS) %>%
                    mutate(Delta_sumh = round(Delta_sumh, 3),
                      p_sumh = round(p_sumh, 3),
                      Tau_sumh = round(Tau_sumh, 3),
                      Denominator_sumh = round(Denominator_sumh, 0),
                      VarScore_sumh = round(VarScore_sumh, 3))


Kendall_table <- as.data.frame(unique(indicator$eel_emu_nameshort)) %>%
  rename(eel_emu_nameshort = "unique(indicator$eel_emu_nameshort)") %>%
  left_join(Kendall_b0_tab %>% select(eel_emu_nameshort, Period_b0, n_b0, Esc_perc_b0_initial, Esc_perc_b0_current, Delta_b0, Tau_b0, p_b0), by = "eel_emu_nameshort") %>%
  left_join(Kendall_b0_adj_tab %>% select(eel_emu_nameshort, Period_b0_adj, n_b0_adj, Esc_perc_b0_adj_initial, Esc_perc_b0_adj_current, Delta_b0_adj, Tau_b0_adj, p_b0_adj), by = "eel_emu_nameshort") %>%
  left_join(Kendall_mort_tab_a %>% select(eel_emu_nameshort, Period_suma, suma_initial, suma_current, n_suma, Delta_suma, Tau_suma, p_suma), by = "eel_emu_nameshort") %>%
  left_join(Kendall_mort_tab_f %>% select(eel_emu_nameshort, Period_sumf, sumf_initial, sumf_current, n_sumf, Delta_sumf, Tau_sumf, p_sumf), by = "eel_emu_nameshort") %>%         
  left_join(Kendall_mort_tab_h %>% select(eel_emu_nameshort, Period_sumh, sumh_initial, sumh_current, n_sumh, Delta_sumh, Tau_sumh, p_sumh), by = "eel_emu_nameshort") %>%
  arrange(eel_emu_nameshort)
  #filter_at(vars(Delta_suma, Delta_sumf, Delta_sumh, Tau_suma, Tau_sumf, Tau_sumh), any_vars(!is.na(.)))

Kendall_summary <- Kendall_table %>%
  mutate(suma=ifelse(n_suma < 5, "less_than_5", 
                     ifelse(p_suma>.1,"no_trend",
                     ifelse(Tau_suma<0, "negative","positive"))),
         sumf=ifelse(n_sumf < 5, "less_than_5",
                     ifelse(p_sumf>.1,"no_trend",
                     ifelse(Tau_sumf<0, "negative","positive"))),
         sumh=ifelse(n_sumh < 5, "less_than_5",
                     ifelse(p_sumh>.1,"no_trend",
                     ifelse(Tau_sumh<0, "negative","positive"))),
         b0=ifelse(n_b0 < 5, "less_than_5",
                     ifelse(p_b0>.1,"no_trend",
                     ifelse(Tau_b0<0, "negative","positive"))),
         b0_adj=ifelse(n_b0_adj < 5, "less_than_5", 
                     ifelse(p_b0_adj>.1,"no_trend",
                     ifelse(Tau_b0_adj<0, "negative","positive"))),
         b0_today=ifelse(Esc_perc_b0_current >= 0.4, "positive", "negative"),
         b0_initial=ifelse(Esc_perc_b0_initial >= 0.4, "positive", "negative")) %>%
  select(suma,sumf,sumh,b0,b0_adj, b0_today, b0_initial) %>%
  pivot_longer(everything(),names_to="indicator", values_to="trend") %>%
  group_by(indicator) %>%
  count(trend) %>%
  pivot_wider(names_from=trend,values_from=n) %>%
  mutate(total = sum(negative, positive, no_trend, less_than_5),
         total_above_5 = sum(negative, positive, no_trend))

library(officer)
thick <- officer::fp_border(color="black", width = 3)

Progress_visualisation <- Kendall_table %>%
  select(eel_emu_nameshort, Esc_perc_b0_current, suma_current, Delta_b0, Delta_suma, Esc_perc_b0_initial, suma_initial) %>% 
  filter_at(vars(Esc_perc_b0_current, Delta_b0, suma_current, Delta_suma, Esc_perc_b0_initial, suma_initial), any_vars(!is.na(.))) %>% 
  mutate(Delta_suma = ifelse(suma_current == suma_initial & suma_initial == 0, NA, Delta_suma))
                     
columns <- c("Esc_perc_b0_current", "suma_current", "Delta_b0", "Delta_suma", "Esc_perc_b0_initial", "suma_initial")

bg_b0 <- scales::col_bin(
  palette = c("coral1", "palegreen3"),
  bins = c(0, 0.4, 100))

bg_Delta_b0 <- scales::col_bin(
  palette = c("coral1", "palegreen3"),
  bins = c(-100, 0.000000001, 100))

bg_suma <- scales::col_bin(
  palette = c("palegreen3", "coral1"),
  bins = c(-100, 0.92, 100))

bg_Delta_suma <- scales::col_bin(
  palette = c("palegreen3", "coral1"),
  bins = c(-100, -0.000000001, 100))

flextable(Progress_visualisation) %>% set_header_labels(eel_emu_nameshort = "EMU",
                    Esc_perc_b0_current = "Bcurrent/B0 (current)",
                    Esc_perc_b0_initial = "Bcurrent/B0 (initial)",
                    suma_current = "\u03A3A (current)",
                    suma_initial = "\u03A3A (initial)",
                    Delta_suma = "Change in \u03A3A since implementation",
                    Delta_b0 = "Change in Bcurrent/B0 since implementation") %>% 
             bg(j = c("Esc_perc_b0_current", "Esc_perc_b0_initial"), bg = bg_b0) %>%
             bg(j = c("suma_current", "suma_initial"), bg = bg_suma) %>%
             bg(j = "Delta_b0", bg = bg_Delta_b0) %>%
             bg(j = "Delta_suma", bg = bg_Delta_suma) %>%
             vline() %>%
             hline() %>%
             vline(j = 5, border = thick) %>%
             vline(j = 3, border = thick) %>% 
             vline_left() %>% 
             #void(j = columns) %>%
             autofit()

detach("package:officer", unload=TRUE)

```

\
\

## Biomass statistics

Time trend analyses are carried out on the ratio of Bcurrent/B0 and Bcurrent/B0_adjusted - as indicated by suffixes.\
B0_adjusted accounts for the fact that while B0, by definition, is a fixed value, Bcurrent partly depends on natural recruitment. The ratio Bcurrent/B0 will thus not accurately reflect the influence of continental factors on escapement biomass (most importantly effects of management measures) but also changes in natural recruitment. B0_adjusted incorporates changes in natural recruitment, therefore canceling out effects of natural recruitment on Bcurrent and removing the bias. Since a multitude of different methods and models is used by countries to calculate biomass indicators a general approximation for the adjustment of B0 was derived from WGEEL recruitment index by... _SENTENCE OR TWO FROM HILAIRE_   

The following restraints were defined for trend analyses:   
1. Only values after 2010 (Implementation of Eel regulation) were considered\
2. Time Series need to have at least 5 observations

Delta gives the difference between the initial (2007) and current (last year reported) ratio of either Bcurrent/Bo or Bcurrent/B0_adjusted - as indicated by suffixes. The value thus indicates a quantitative measure of the change in biomass whereas Tau gives a qualitative estimate on whether the trend is positive/negative and significant (also see table footnote).

```{r KtableB0}

flextable(Kendall_table %>%
            rename(EMU = eel_emu_nameshort) %>%
            mutate(Tau_b0 = ifelse(p_b0 <= 0.1, 
                            ifelse(p_b0 <= 0.05, paste(Tau_b0, "**"), paste(Tau_b0, "*")), as.character(Tau_b0)))  %>%
            select(EMU, Period_b0, n_b0, Esc_perc_b0_initial, Esc_perc_b0_current, Delta_b0, Tau_b0) %>%
            mutate_all(~ifelse(is.nan(.), NA, .)) %>%
            filter_at(vars(n_b0,  Esc_perc_b0_initial, Esc_perc_b0_current, Delta_b0, Tau_b0), any_vars(!is.na(.)))) %>%
  set_header_labels(Period_b0 = "Period",
                    n_b0 = "n",
                    Esc_perc_b0_initial = "Bcurrent/B0 (initial)",
                    Esc_perc_b0_current = "Bcurrent/B0 (current)",
                    Delta_b0 = "\u0394 Bcurrent/B0",
                    Tau_b0 = "\u03C4 B0") %>%
            autofit()
```

[*] indicates p > 0.1\
[**] indicates p > 0.05


```{r KtableBB0_adj}

flextable(Kendall_table %>%
            rename(EMU = eel_emu_nameshort) %>%
            mutate(Tau_b0_adj = ifelse(p_b0_adj <= 0.1,
                               ifelse(p_b0_adj <= 0.05, paste(Tau_b0_adj, "**"), paste(Tau_b0_adj, "*")), as.character(Tau_b0_adj)))  %>%
            select(EMU, Period_b0_adj, n_b0_adj, Esc_perc_b0_adj_initial, Esc_perc_b0_adj_current, Delta_b0_adj, Tau_b0_adj) %>%
            mutate_all(~ifelse(is.nan(.), NA, .)) %>%
            filter_at(vars(n_b0_adj, Esc_perc_b0_adj_initial, Esc_perc_b0_adj_current, Delta_b0_adj, Tau_b0_adj), any_vars(!is.na(.)))) %>%
  set_header_labels(Period_b0_adj = "Period",
                    n_b0_adj = "n",
                    Esc_perc_b0_adj_initial = "Bcurrent/B0-adj (initial)",
                    Esc_perc_b0_adj_current = "Bcurrent/B0-adj (current)",
                    Delta_b0_adj = "\u0394 Bcurrent/B0-adj",
                    Tau_b0_adj = "\u03C4 B0-adj") %>%
            autofit()
```

[*] indicates p > 0.1\
[**] indicates p > 0.05

\
\

## Mortality statistics

Time trend analyses are carried out on the mortalites suma, sumf and sumh - as indicated by suffixes.\ 
The following restraints were defined for trend analyses:   
1. Only values after 2010 (Implementation of Eel regulation) were considered\
2. Time Series need to have at least 5 observations

Delta gives the difference between the initial (2010) and current (latest year reported) suma, sumf or sumh - as indicated by suffixes. The value thus indicates a quantitative measure of the change in mortality, whereas Tau gives a qualitative estimate on whether the trend is positive/negative and significant (also see table footnote).



*Tab* Results of the Kendall-Test for SumA

```{r Ktablesuma}

flextable(Kendall_table %>%
            mutate(Tau_suma = ifelse(p_suma <= 0.1, 
                            ifelse(p_suma <= 0.05, paste(Tau_suma, "**"), paste(Tau_suma, "*")), as.character(Tau_suma)))  %>%
            select(eel_emu_nameshort, Period_suma, suma_initial, suma_current, n_suma, Delta_suma, Tau_suma) %>%
            mutate_all(~ifelse(is.nan(.), NA, .)) %>%
            relocate(n_suma, .after = Period_suma) %>%
            filter_at(vars(suma_initial, suma_current, n_suma, Delta_suma, Tau_suma), any_vars(!is.na(.)))) %>%
            set_header_labels(eel_emu_nameshort = "EMU",
                              Period_suma = "Period",
                              suma_initial = "\u03A3A (initial)",
                              suma_current = "\u03A3A (current)",
                              n_suma = "n",
                              Delta_suma = "\u0394 \u03A3A",
                              Tau_suma = "\u03C4 \u03A3A") %>%
            autofit()
```

\
\
*Tab* Results of the Kendall-Test for SumF

```{r Ktablesumf}
flextable(Kendall_table %>%
            mutate(Tau_sumf = ifelse(p_sumf <= 0.1, 
                            ifelse(p_sumf <= 0.05, paste(Tau_sumf, "**"), paste(Tau_sumf, "*")), as.character(Tau_sumf)))  %>%
            select(eel_emu_nameshort, Period_sumf, sumf_initial, sumf_current, n_sumf, Delta_sumf, Tau_sumf) %>%
            mutate_all(~ifelse(is.nan(.), NA, .)) %>%
            relocate(n_sumf, .after = Period_sumf) %>%
            filter_at(vars(sumf_initial, sumf_current, n_sumf, Delta_sumf, Tau_sumf), any_vars(!is.na(.)))) %>%
            set_header_labels(eel_emu_nameshort = "EMU",
                              Period_sumf = "Period",
                              sumf_initial = "\u03A3F (initial)",
                              sumf_current = "\u03A3F (current)",
                              n_sumf = "n",
                              Delta_sumf = "\u0394 \u03A3F",
                              Tau_sumf = "\u03C4 \u03A3F") %>%
            autofit()
```

\
\
*Tab* Results of the Kendall-Test for SumH

```{r Ktablesumh}
flextable(Kendall_table %>%
            mutate(Tau_sumh = ifelse(p_sumh <= 0.1, 
                            ifelse(p_sumh <= 0.05, paste(Tau_sumh, "**"), paste(Tau_sumh, "*")), as.character(Tau_sumh)))  %>%
            select(eel_emu_nameshort, Period_sumh, sumh_initial, sumh_current, n_sumh, Delta_sumh, Tau_sumh) %>%
            relocate(n_sumh, .after = Period_sumh) %>%
            mutate_all(~ifelse(is.nan(.), NA, .)) %>%
            filter_at(vars(sumh_initial, sumh_current, n_sumh, Delta_sumh, Tau_sumh), any_vars(!is.na(.)))) %>%
            set_header_labels(eel_emu_nameshort = "EMU",
                              Period_sumh = "Period",
                              sumh_initial = "\u03A3H (initial)",
                              sumh_current = "\u03A3H (current)",
                              n_sumh = "n",
                              Delta_sumh = "\u0394 \u03A3H",
                              Tau_sumh = "\u03C4 \u03A3H") %>%
            autofit()
```


[*] indicates 0.05 < p < 0.1\
[**] indicates p < 0.05



# Test for effect of measures
## Fisher's exact Test
### Comparing effect between measures

Fisher's exact test for all EMUs where respective measures were implemented. The test is performed on measure type (10 types, but no data for 2 of them) x count of EMUs with an effect / no effect on either SumA, SumF, SumH or bcurr/b0 adjusted (=b0_adj). The result indicates whether an effect on either parameter was independent (=null hypothesis) of the measure type.\

_-_Result for b0 is interesting, eel governance seems to have an effect (tested specifically for this measure it is significant, see below), but overall b0 does not seem to dependend on measure type. Is that because "stochastically this is expected" (at 0.05 one in 20 would show dependence coincidentally, right?) / is the power not good. Not sure it makes sense or I make sense;) ..._

_Need to check if this makes sense, since the EMUs for the different measures are not the same but those where the respective measure was implemented_

```{r Fisher_all}
#### CAREFUL, THIS SECTION MIGHT NEED REVISION SINCE POSSIBLY NAs ARE DROPPED THAT SHOULD BE INCLUDED AS ZEROES####
load("./data_dependencies/Annex15.Rdata")

counts <- res %>%
  mutate(emu_name_short = str_replace(emu_name_short, "NL_Neth", "NL_total")) %>%
  group_by(emu_name_short) %>%
  count(measure_type)

measures <- expand.grid(EMU = unique(res$emu_name_short),
            measure_type = unique(res$measure_type)) %>%
            mutate(EMU = str_replace(EMU, "NL_Neth", "NL_total")) %>% 
            left_join(counts, by=c("EMU" = "emu_name_short", "measure_type" = "measure_type")) %>%
            replace(is.na(.), 0) %>%
            mutate(binary_measure = ifelse(n == 0 , 0 , 1),
                   n = NULL) %>%
            left_join(Kendall_table %>% select(eel_emu_nameshort, p_suma, p_sumf, p_sumh, Tau_suma, Tau_sumf, Tau_sumh), by = c("EMU" = "eel_emu_nameshort")) %>%
            left_join(Kendall_table %>% select(eel_emu_nameshort, p_b0, p_b0_adj, Tau_b0, Tau_b0_adj), by = c("EMU" = "eel_emu_nameshort")) %>%
            mutate(sumA = ifelse(p_suma < 0.1 & Tau_suma < 0, 1, 0),
                   sumF = ifelse(p_sumf < 0.1 & Tau_sumf < 0, 1, 0),
                   sumH = ifelse(p_sumh < 0.1 & Tau_sumh < 0, 1, 0),
                   b0 = ifelse(p_b0 < 0.1 & Tau_b0 > 0, 1, 0),
                   b0_adj = ifelse(p_b0_adj < 0.1 & Tau_b0_adj > 0, 1, 0))

Fisher_sumA <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumA) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumA, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_sumF <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumF) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumF, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_sumH <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, sumH) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(sumH, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

Fisher_b0_adj <- measures %>%
  mutate(measure_type = str_replace(measure_type, "Recreational fishery", "Recreational_fishery")) %>%
  filter(binary_measure == 1) %>%
  group_by(measure_type, b0_adj) %>%
  summarise(effect = n(), .groups = "keep") %>%
  spread(b0_adj, effect) %>%
  rename(effect = "1",
         no_effect = "0") %>%
  mutate("<NA>" = NULL) %>%
  drop_na() %>%
  mutate(total = sum(effect, no_effect),
         percentage = effect/total*100) %>%
  relocate(effect, .after = measure_type)

flextable(Fisher_sumA) %>% autofit() %>% set_caption(caption = paste("sumA, p =", round((fisher.test(Fisher_sumA[,c(2,3)])$p.value), 3)))
flextable(Fisher_sumF) %>% autofit() %>% set_caption(caption = paste("sumF, p =", round((fisher.test(Fisher_sumF[,c(2,3)])$p.value), 3)))
flextable(Fisher_sumH) %>% autofit() %>% set_caption(caption = paste("sumH, p =", round((fisher.test(Fisher_sumH[,c(2,3)])$p.value), 3)))
flextable(Fisher_b0_adj) %>% autofit() %>% set_caption(caption = paste("b0 adjusted, p =", round((fisher.test(Fisher_b0_adj[,c(2,3)])$p.value), 3)))

```



### Comparing effect per measure (implemented vs not implemented)

Fishers exact test is performed on a 2x2 matrix per measure, i.e. count of EMUs wher measure is implemented / not implemented x count of EMus with an effect / no effect on either SumA, SumF, SumH or bcurr/b0 adjusted (=b0_adj). The test indicates whether an effect on either parameter was independent (= null hypothesis) of the implementation of the respective measure type. 

```{r Fisher_by_measure}

fisher_sumA <- measures %>% 
                     group_by(measure_type, binary_measure, sumA) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     mutate(indicator = paste(binary_measure, sumA, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumA) %>%
                     spread(indicator, value) %>%
                     replace(is.na(.), 0) %>%
                     mutate(NAs = paste(implemented_NA, not_implemented_NA, sep ="/")) %>% 
                     select(-implemented_NA, not_implemented_NA)


 
fisher_sumA$p <- apply(fisher_sumA %>% select(-NAs), 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

fisher_sumA <- fisher_sumA %>%  
  select(measure_type, implemented_0, implemented_1, not_implemented_0, not_implemented_1, p, NAs) %>% 
  mutate(p = round(p, 3))

######################################

fisher_sumF <- measures %>% 
                     group_by(measure_type, binary_measure, sumF) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     mutate(indicator = paste(binary_measure, sumF, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumF) %>%
                     spread(indicator, value) %>%
                     replace(is.na(.), 0) %>%
                     mutate(NAs = paste(implemented_NA, not_implemented_NA, sep ="/")) %>% 
                     select(-implemented_NA, not_implemented_NA)
 
fisher_sumF$p <- apply(fisher_sumF %>% select(-NAs), 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

fisher_sumF <- fisher_sumF %>%  
  select(measure_type, implemented_0, implemented_1, not_implemented_0, not_implemented_1, p, NAs) %>% 
  mutate(p = round(p, 3))

######################################
                                        
fisher_sumH <- measures %>% 
                     group_by(measure_type, binary_measure, sumH) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     mutate(indicator = paste(binary_measure, sumH, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, - sumH) %>%
                     spread(indicator, value) %>%
                     replace(is.na(.), 0) %>%
                     mutate(NAs = paste(implemented_NA, not_implemented_NA, sep ="/")) %>% 
                     select(-implemented_NA, not_implemented_NA)
 
fisher_sumH$p <- apply(fisher_sumH %>% select(-NAs), 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

fisher_sumH <- fisher_sumH %>%  
  select(measure_type, implemented_0, implemented_1, not_implemented_0, not_implemented_1, p, NAs) %>% 
  mutate(p = round(p, 3))

######################################  

fisher_b0 <- measures %>% 
                     group_by(measure_type, binary_measure, b0) %>%
                     summarise(value = n()) %>%
                     mutate(binary_measure = str_replace(binary_measure, "0", "not_implemented"),
                            binary_measure = str_replace(binary_measure, "1", "implemented")) %>%
                     mutate(indicator = paste(binary_measure, b0, sep = "_")) %>%
                     ungroup() %>%
                     select(-binary_measure, -b0) %>%
                     spread(indicator, value) %>%
                     replace(is.na(.), 0) %>%
                     mutate(NAs = paste(implemented_NA, not_implemented_NA, sep ="/")) %>% 
                     select(-implemented_NA, not_implemented_NA)
 
fisher_b0$p <- apply(fisher_b0 %>% select(-NAs), 1 ,function(x) {
                                        tbl <- matrix(as.numeric(x[2:5]), ncol=2, byrow=T)
                                        fisher.test(tbl)$p.value
                                        })

fisher_b0 <- fisher_b0 %>%  
  select(measure_type, implemented_0, implemented_1, not_implemented_0, not_implemented_1, p, NAs) %>% 
  mutate(p = round(p, 3))
  

############## OUTPUT TABLES###################

library(officer)
thick <- officer::fp_border(color="black", width = 2.5)
thin <- officer::fp_border(color="black", width = 1)


flextable(fisher_sumA) %>% set_caption(caption = "\u03A3A") %>%
  set_header_labels(implemented_0 = "implemented/no effect",
                    implemented_1 = "implemented/effect",
                    not_implemented_0 = "not implemented/no effect",
                    not_implemented_1 = "not implemented/effect",
                    NAs = "Not tested (implemented/not implemented)",
                    measure_type = "Measure type") %>% 
  vline(j = 5, border = thin) %>%
  vline(j = 6, border = thick) %>%
  autofit() 

flextable(fisher_sumF) %>% set_caption(caption = "\u03A3F") %>%
  set_header_labels(implemented_0 = "implemented/no effect",
                    implemented_1 = "implemented/effect",
                    not_implemented_0 = "not implemented/no effect",
                    not_implemented_1 = "not implemented/effect",
                    NAs = "Not tested (implemented/not implemented)",
                    measure_type = "Measure type") %>%
  vline(j = 5, border = thin) %>%
  vline(j = 6, border = thick) %>%
  autofit()

flextable(fisher_sumH) %>% set_caption(caption = "\u03A3H") %>%
  set_header_labels(implemented_0 = "implemented/no effect",
                    implemented_1 = "implemented/effect",
                    not_implemented_0 = "not implemented/no effect",
                    not_implemented_1 = "not implemented/effect",
                    NAs = "Not tested (implemented/not implemented)",
                    measure_type = "Measure type") %>%
  vline(j = 5, border = thin) %>%
  vline(j = 6, border = thick) %>%
  autofit()

flextable(fisher_b0) %>% set_caption(caption = "b0") %>%
  set_header_labels(implemented_0 = "implemented/no effect",
                    implemented_1 = "implemented/effect",
                    not_implemented_0 = "not implemented/no effect",
                    not_implemented_1 = "not implemented/effect",
                    NAs = "Not tested (implemented/not implemented)",
                    measure_type = "Measure type") %>%
  vline(j = 5, border = thin) %>%
  vline(j = 6, border = thick) %>%
  autofit()

detach("package:officer", unload=TRUE)

```



## Logistic regression
### Relation SigA and Bcurr

```{r delta_Bcurr_vs_sigA_graph}

require(lme4)
delta <- Kendall_table %>%
                select(eel_emu_nameshort, Period_suma, suma_initial, suma_current, Delta_suma, Tau_b0_adj, p_b0_adj, Period_b0, Period_b0_adj, Tau_b0, p_b0) %>%
                mutate(binary_b0_adj = ifelse(Tau_b0_adj > 0 & p_b0_adj < 0.1, 1, 0),
                       binary_b0 = ifelse(Tau_b0 > 0 & p_b0 < 0.1, 1, 0),
                       test_period_b0 = ifelse(Period_suma != Period_b0, "Period_b0_diff", "OK"),
                       test_period_b0_adj = ifelse(Period_suma != Period_b0_adj, "Period_b0_adj_diff", "OK"),
                       Tau_b0_adj = NULL,
                       p_b0_adj = NULL,
                       Tau_b0 = NULL,
                       p_b0 = NULL) 

#MAYBE ADD WARNING HERE THAT IS DISPLAYD IN THE PRODUCED TABLE/GRAPH IF TIME PERIODS DO NOT MATCH (FOR NON-NA CASES) - IT IS FINE THOUGH FOR THIS ANALYSIS

logit_delta_b0 <- glm(binary_b0 ~ Delta_suma, family=binomial(link="logit"), data = delta)               
logit_delta_b0_adj <- glm(binary_b0_adj ~ Delta_suma, family=binomial(link="logit"), data = delta)
logit_delta_b0_adj_1 <- glm(binary_b0_adj ~ Delta_suma, family=binomial(link="logit"), data = delta %>% filter(Delta_suma < 1 & Delta_suma > -1))

new_delta <- expand.grid(Delta_suma = seq(min(delta$Delta_suma[!is.na(delta$Delta_suma)]), max(delta$Delta_suma[!is.na(delta$Delta_suma)]), by =0.1))
                         

ggplot(delta, aes(x=Delta_suma, y=binary_b0_adj)) +
  geom_point(size=0.9)+
  theme_bw()+
  geom_line(data= new_delta, aes(x=Delta_suma, y=predict(logit_delta_b0_adj, type = "response", newdata = new_delta)), size = 0.3)+
  labs(x = "\u0394 \u03A3A", y = expression("Change in B"["current"]*"/"*"B"["0_adj"]~"(0=no increase, 1=increase)"))

ggplot(delta, aes(x=Delta_suma, y=binary_b0)) +
  geom_point(size=0.9)+
  theme_bw()+
  geom_line(data= new_delta, aes(x=Delta_suma, y=predict(logit_delta_b0, type = "response", newdata = new_delta)), size = 0.3)+
  labs(x = "\u0394 \u03A3A", y = expression("Change in B"["current"]*"/"*"B"["0"]~"(0=no increase, 1=increase)"))
```

*Fig* Relation between change in anthropogenic mortalities and whether or not there is a positive trend in the escapement biomass.      

*Tab* Model statistics for Logistic regression of change in Biomass expressed as Bcurrent/B0_adjusted over change in mortalities expressed as Delta sumA (for time period see Kendall table). Values marked with (all) use all available data where estimates of biomass and change in mrtality are available, values marked with (truncated) only use data where Delta SumA was between 1 and -1. 

```{r delta_Bcurr_vs_sigA_table}


logit_delta_table <- as.data.frame(summary(logit_delta_b0_adj)$coefficients) %>%
        mutate(Coefficient = ifelse(row_number() == 1, "Intercept", "\u0394 \u03A3A")) %>%
        relocate(Coefficient, .before = Estimate) %>%
        rename_with(.col = 5, ~ "p-value (all)") %>%
        left_join(as.data.frame(summary(logit_delta_b0_adj_1)$coefficients) %>%
        mutate(Coefficient = ifelse(row_number() == 1, "Intercept", "\u0394 \u03A3A")) %>%
        relocate(Coefficient, .before = Estimate) %>%
        rename_with(.col = 5, ~ "p-value (truncated)"), by = "Coefficient") %>%
        rename("Estimate (all)" = "Estimate.x",
               "SE (all)" = "Std. Error.x",
                "z (all)" = "z value.x",
               "Estimate (truncated)" = "Estimate.y",
               "SE (truncated)" = "Std. Error.y",
                "z (truncated)" = "z value.y",)

flextable(logit_delta_table) %>% autofit()

```


### Effect of number of measures on Stock indicators

```{r logit_numbers_prep}
measures_n <- expand.grid(EMU = unique(res$emu_name_short),
            measure_type = unique(res$measure_type)) %>%
            left_join(counts, by=c("EMU" = "emu_name_short", "measure_type" = "measure_type")) %>%
            replace(is.na(.), 0) %>%
            left_join(Kendall_table %>% select(eel_emu_nameshort, p_suma, p_sumf, p_sumh, Tau_suma, Tau_sumf, Tau_sumh, p_b0, p_b0_adj, Tau_b0, Tau_b0_adj), by = c("EMU" = "eel_emu_nameshort")) %>%
            mutate(sumA = ifelse(p_suma < 0.1 & Tau_suma < 0, 1, 0),
                   sumF = ifelse(p_sumf < 0.1 & Tau_sumf < 0, 1, 0),
                   sumH = ifelse(p_sumh < 0.1 & Tau_sumh < 0, 1, 0),
                   b0 = ifelse(p_b0 < 0.1 & Tau_b0 > 0, 1, 0),
                   b0_adj = ifelse(p_b0_adj < 0.1 & Tau_b0_adj > 0, 1, 0)) %>%
                   select(EMU, measure_type, n, sumA, sumF, sumH, b0_adj)

logit_measures_n_sumA <- glm(sumA ~ n + measure_type + n:measure_type-1, family=binomial(link="logit"), data = measures_n)
logit_measures_n_sumF <- glm(sumF ~ n + measure_type + n:measure_type-1, family=binomial(link="logit"), data = measures_n)
logit_measures_n_sumH <- glm(sumH ~ n + measure_type + n:measure_type-1, family=binomial(link="logit"), data = measures_n)
logit_measures_n_b0_adj <- glm(b0_adj ~ n + measure_type + n:measure_type-1, family=binomial(link="logit"), data = measures_n)

new_measures_n <- expand.grid(n = seq(0, max(measures_n$n), by =0.5),
                         measure_type = unique(measures_n$measure_type))
```

```{r logit_n_sumA_graph}
ggplot(measures_n, aes(x=n, y=sumA)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_n, aes(x=n, y=predict(logit_measures_n_sumA, type = "response", newdata = new_measures_n), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumA (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumA vs number of measures

*Tab* Table with model statistics for SumA vs number of measures

```{r logit_n_sumA_table}
summary_n_sumA <- as.data.frame(summary(logit_measures_n_sumA)$coefficients) 
summary_n_sumA$coefficients <- rownames(summary_n_sumA)
flextable(summary_n_sumA %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit_n_sumF_graph}
ggplot(measures_n, aes(x=n, y=sumF)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_n, aes(x=n, y=predict(logit_measures_n_sumF, type = "response", newdata = new_measures_n), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumF (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumF vs number of measures

*Tab* Table with model statistics for SumF vs number of measures

```{r logit_n_sumF_table}
summary_n_sumF <- as.data.frame(summary(logit_measures_n_sumF)$coefficients) 
summary_n_sumF$coefficients <- rownames(summary_n_sumF)
flextable(summary_n_sumF %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit_n_sumH_graph}
ggplot(measures_n, aes(x=n, y=sumH)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_n, aes(x=n, y=predict(logit_measures_n_sumH, type = "response", newdata = new_measures_n), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumH (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumH vs number of measures

*Tab* Table with model statistics for SumH vs number of measures

```{r logit_n_sumH_table}
summary_n_sumH <- as.data.frame(summary(logit_measures_n_sumH)$coefficients) 
summary_n_sumH$coefficients <- rownames(summary_n_sumH)
flextable(summary_n_sumH %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit_n_Bcurr_graph}
ggplot(measures_n, aes(x=n, y=b0_adj)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_n, aes(x=n, y=predict(logit_measures_n_b0_adj, type = "response", newdata = new_measures_n), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on Bcurr (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for Bcurr vs number of measures

*Tab* Table with model statistics for Bcurr vs number of measures

```{r logit_n_Bcurr_table}
summary_n_b0_adj <- as.data.frame(summary(logit_measures_n_b0_adj)$coefficients) 
summary_n_b0_adj$coefficients <- rownames(summary_n_b0_adj)
flextable(summary_n_b0_adj %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```



### Effect of measure scores on stock indicators

```{r logit_scores_prep}
scores <- res %>%
  mutate(impact = ifelse(impact == "High", 3, 
                    ifelse(impact == "Intermediate", 2, 
                      ifelse(impact == "Low", 1, NA)))) %>%
  group_by(emu_name_short, measure_type) %>%
  summarise(score = sum(impact)) %>%
  drop_na()

measures_scores <- expand.grid(EMU = unique(res$emu_name_short),
            measure_type = unique(res$measure_type)) %>%
            left_join(scores, by=c("EMU" = "emu_name_short", "measure_type" = "measure_type")) %>%
            drop_na() %>%
            left_join(Kendall_table %>% select(eel_emu_nameshort, p_suma, p_sumf, p_sumh, Tau_suma, Tau_sumf, Tau_sumh, eel_emu_nameshort, p_b0, p_b0_adj, Tau_b0, Tau_b0_adj), by = c("EMU" = "eel_emu_nameshort")) %>%
            mutate(sumA = ifelse(p_suma < 0.1 & Tau_suma < 0, 1, 0),
                   sumF = ifelse(p_sumf < 0.1 & Tau_sumf < 0, 1, 0),
                   sumH = ifelse(p_sumh < 0.1 & Tau_sumh < 0, 1, 0),
                   b0 = ifelse(p_b0 < 0.1 & Tau_b0 > 0, 1, 0),
                   b0_adj = ifelse(p_b0_adj < 0.1 & Tau_b0_adj > 0, 1, 0)) %>%
                   select(EMU, measure_type, score, sumA, sumF, sumH, b0_adj)

measures_scores <- measures_scores[!with(measures_scores, is.na(sumA) & is.na (sumF) & is.na(sumA) & is.na(b0_adj)),]

logit_measures_scores_sumA <- glm(sumA ~ score + measure_type + score:measure_type-1, family=binomial(link="logit"), data = measures_scores)
logit_measures_scores_sumF <- glm(sumF ~ score + measure_type + score:measure_type-1, family=binomial(link="logit"), data = measures_scores)
logit_measures_scores_sumH <- glm(sumH ~ score + measure_type + score:measure_type-1, family=binomial(link="logit"), data = measures_scores)
logit_measures_scores_b0_adj <- glm(b0_adj ~ score + measure_type + score:measure_type-1, family=binomial(link="logit"), data = measures_scores)

new_measures_scores <- expand.grid(score = seq(0, max(measures_scores$score), by =0.5),
                         measure_type = unique(measures_scores$measure_type)) 

```

```{r logit_scores_sumA_graph}
ggplot(measures_scores, aes(x=score, y=sumA)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_scores, aes(x=score, y=predict(logit_measures_scores_sumA, type = "response", newdata = new_measures_scores), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumA (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumA vs score of measures

*Tab* Table with model statistics for SumA vs score of measures

```{r logit_scores_sumA_table}
summary_scores_sumA <- as.data.frame(summary(logit_measures_scores_sumA)$coefficients) 
summary_scores_sumA$coefficients <- rownames(summary_scores_sumA)
flextable(summary_scores_sumA %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit_scores_sumF_graph}
ggplot(measures_scores, aes(x=score, y=sumF)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_scores, aes(x=score, y=predict(logit_measures_scores_sumF, type = "response", newdata = new_measures_scores), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumF (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumF vs score of measures

*Tab* Table with model statistics for SumF vs score of measures

```{r loogit_scores_sumF_table}
summary_scores_sumF <- as.data.frame(summary(logit_measures_scores_sumF)$coefficients) 
summary_scores_sumF$coefficients <- rownames(summary_scores_sumF)
flextable(summary_scores_sumF %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit_scores_sumH_graph}
ggplot(measures_scores, aes(x=score, y=sumH)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_scores, aes(x=score, y=predict(logit_measures_scores_sumH, type = "response", newdata = new_measures_scores), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on SumH (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
  facet_wrap(~measure_type)
```

*Fig* Logistic regression for SumH vs score of measures

*Tab* Table with model statistics for SumH vs score of measures

```{r logit_scores_sumH_table}
summary_scores_sumH <- as.data.frame(summary(logit_measures_scores_sumH)$coefficients) 
summary_scores_sumH$coefficients <- rownames(summary_scores_sumH)
flextable(summary_scores_sumH %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```
\
\
\
\
\


```{r logit__scores_bcurr_by_b0adj_graph}
test <- measures_scores %>% filter(measure_type != "Eel_governance")

ggplot(measures_scores %>% filter(measure_type != "Eel_governance"), aes(x=score, y=b0_adj)) +
  geom_point(aes(col=measure_type), size=0.9)+
  theme_bw()+
  geom_line(data = new_measures_scores %>% filter(measure_type != "Eel_governance"), aes(x=score, y=predict(logit_measures_scores_b0_adj, type = "response", newdata = new_measures_scores %>% filter(measure_type != "Eel_governance")), col = measure_type), size = 0.3)+
  labs(x = "number of measures", y = "Effect on Bcurr (1 = present, 0 = absent)")+
  theme(legend.position = "none")+
 facet_wrap(~measure_type)
```

*Fig* Logistic regression for Bcurr vs score of measures

*Tab* Table with model statistics for Bcurr vs score of measures\
_careful here, I am not sure about the interpretation of "Eel_governance", since twe have EMUs with governance but no Bcurr effect measured anywhere_

```{r logit__scores_bcurr_by_b0adj_table}
summary_scores_b0_adj <- as.data.frame(summary(logit_measures_scores_b0_adj)$coefficients) 
summary_scores_b0_adj$coefficients <- rownames(summary_scores_sumH)
flextable(summary_scores_b0_adj %>% relocate(coefficients, .before = Estimate)) %>% autofit()
```

## Effect of measures vs sources of mortality



```{r measures_vs_mortalities}

meas_mort <- indicator %>% filter(eel_year >= 2007) %>%
                group_by(eel_emu_nameshort) %>%
                filter(eel_year == min(eel_year) | eel_year == max(eel_year)) %>%
                mutate(start_year = min(eel_year),
                       eel_year = ifelse(eel_year == start_year, "initial", "final"),
                       start_year = start_year) %>%
                ungroup() %>%
                filter(start_year <= 2011) %>%
                select(start_year, eel_year, suma, sumf, sumh, eel_emu_nameshort, eel_cou_code) %>%
                gather(key = "mortality_indicator", value = "value", c(suma, sumh, sumf)) %>%
                mutate(mortality_indicator = paste(mortality_indicator, eel_year, sep = "_"),
                       eel_year = NULL, 
                       start_year = as.factor(start_year)) %>%
                spread(mortality_indicator, value) %>%
                mutate(delta_sumf = sumf_final - sumf_initial,
                       delta_sumh = sumh_final - sumh_initial, 
                       delta_suma = suma_final - suma_initial)

require(ggrepel)

ggplot(meas_mort, aes(x=suma_initial, y=delta_suma)) +
  geom_point(size = 1) + 
   geom_text_repel(aes(label = eel_emu_nameshort, col = start_year), size = 3.2, max.overlaps = 50)+ 
  theme_bw()+
  geom_hline(yintercept = 0, col = "black", size = 0.5)+
  geom_vline(xintercept = 0.92, col = "red", linetype = "dashed", size = 0.5)+
  labs(x = "Initial \u03A3A", y = "\u0394 \u03A3A")

ggplot(meas_mort, aes(x=sumf_initial, y=delta_sumf)) + 
  geom_point(size = 1.5) + 
  geom_text_repel(aes(label = eel_emu_nameshort, col = start_year), size = 3.2, max.overlaps = 50)+
  geom_hline(yintercept = 0, col = "black", size = 0.5)+
  theme_bw()+
  labs(x = "Initial \u03A3F", y = "\u0394 \u03A3F")
  
ggplot(meas_mort, aes(x=sumh_initial, y=delta_sumh)) + 
  geom_point(size = 1) +
  geom_text_repel(aes(label = eel_emu_nameshort, col = start_year), size = 3.2, max.overlaps = 50)+
  geom_hline(yintercept = 0, col = "black", size = 0.5)+
  theme_bw()+
  labs(x = "Initial \u03A3H", y = "\u0394 \u03A3H")



```

*Fig* Relation of the change in mortality to the initial mortality levels. The initial mortality is defined as the earliest estimate that was reported after the year 2007 (but no later than 2011, initial year indicated by colour) to best representat pre-EMP levels. However, for some EMUs no pre-EMP estimates were reported and thus rather reflect mortality levels shortly after implementation of EMPs. The latest most recent value for mortality was used to calculate delta, see Tab xx.  
EMUs where only values after 2011 were reported are not shown.   

