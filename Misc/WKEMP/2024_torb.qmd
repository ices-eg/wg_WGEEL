---
title: "WKEMP4"
date: "2025-01-24"
documentclass: report
execute:
  echo: false
  warning: false
  message: false
  error: false
format:
  docx:
    fig_caption: yes
    keep-md: true
    reference-doc: "../../R/quarto/ICES_template.docx"
params:
  image_path: "2024/image"
  quarto_path: "../../R/quarto/"
lang: fr
bibliography: "../../R/quarto/ICES.bib"
csl: "../../R/quarto/ices-journal-of-marine-science.csl"
crossref:
  chapters: true
  fig-prefix: ''
  tbl-prefix: ''
  eq-prefix: ''
  ref-hyperlink: true
link-citations: true
link-bibliography: true
---

```{r qmdhelper}
#| echo: FALSE
#| eval: FALSE
#| label: qmdhelper
# this is only necessary in eclipse, VScodium outside quarto render
#  Rstudio or vscodium quarto render should have param ready
# so you just need to launch this manually to make your code work

params <- list(image_path = "2024/image",
  quarto_path = "../../R/quarto/")
setwd(dirname(.vsc$rstudioapi_env$getSourceEditorContext()$path))
#setwd("c:/workspace/wg_WGEEL/Misc/WKEMP")
```

```{r init}
#| echo: false
#| warning: false
#| message: false
#| label: init

source(file.path(params$quarto_path,"quarto_utilities.R"))

library(dplyr)
library(ggrepel)
library(viridis)
library(stringr)
library(vegan)
library(sf)

library(RPostgres)
library(getPass)
library(tidyr)
library(officer)
library(officedown)
library(yaml)
cred=read_yaml("../../credentials.yml")
con = dbConnect(Postgres(), dbname=cred$dbname,host=cred$host,port=cred$port,user=cred$user, password=cred$password)
eu_cou_codes =c("AT",	"BE",	"BG",	"HR",	"CY",	"CZ",	"DK",	"EE",	"FI",	"FR",	"DE",	"GR",	"HU",	"IE",	"IT",	"LV",	"LT",	"LU",	"MT",	"NL",	"PL",	"PT",	"RO",	"SK",	"SI",	"ES",	"SE")
precodata_all=dbGetQuery(con,"select * from datawg.precodata_all") %>%
  filter(eel_cou_code %in% eu_cou_codes)
country_ref <- dbGetQuery(con, "select cou_code from ref.tr_country_cou")
values <- c(
  RColorBrewer::brewer.pal(12, "Set3"),
  RColorBrewer::brewer.pal(12, "Paired"),
  RColorBrewer::brewer.pal(8, "Accent"),
  RColorBrewer::brewer.pal(8, "Dark2")
)
color_countries <- setNames(values, country_ref$cou_code)
dbDisconnect(con)
```

```{r}
#| label: functiontrend
#| echo: false

trendtable <- function(dat = precodata_all, ind = "suma"){
  dat |>
    filter(aggreg_level == "emu") |>
    filter(eel_year >= 2017) |>
    select(all_of(c("eel_year",ind, "eel_emu_nameshort"))) |>
    filter(!is.na(.data[[ind]])) |>
    group_by(eel_emu_nameshort) |>
    arrange(eel_year) |>
    dplyr::summarise(`Years`=paste0(min(eel_year), "-", max(eel_year)),
                     `n years` = sum(!is.na(.data[[ind]])),
                     `Initial` = .data[[ind]][which.min(eel_year)],
                     `Final` = .data[[ind]][which.max(eel_year)],
                     `Δ` = Final - Initial,
                     `tau Kendall` = ifelse(sum(!is.na(.data[[ind]]))>4, 
                                            (round(Kendall::MannKendall(.data[[ind]])$tau, digits=2)),
                                            NA),
                     `p-value Kendall` =ifelse(sum(!is.na(.data[[ind]]))>3,  (round(Kendall::MannKendall(.data[[ind]])$sl, digits = 2)),
                                               NA),
                     .groups = "keep") |>
    ungroup() |>
    arrange(eel_emu_nameshort) |>
    rename(EMU=eel_emu_nameshort)
  
}
```

```{r functionpreco}
#| echo: false
#| label: functionpreco

#' @title Draw background of the precautionary diagram
background2<-function(Aminimum=0,Amaximum=6.5,Bminimum=1e-2,Bmaximum=1){
  # the left of the graph is filled with polygons
  Bminimum<<-Bminimum
  Bmaximum<<-Bmaximum
  Amaximum<<-Amaximum
  Aminimum<<-Aminimum
  B<-seq(Bminimum,0.4, length.out=30)
  Amgt<-0.92
  Btrigger=0.4
  SumA<-Amgt*(B/Btrigger) # linear decrease in proportion to B/Btrigger
  X<-c(B,rev(B))
  Ylowersquare<-c(SumA,rep(Aminimum,length(B)))
  df<-data.frame("B"=X,"SumA"=Ylowersquare,"color"="orange")
  Yuppersquare<-c(SumA,rep(Amaximum,length(B)))
  df<-rbind(df, data.frame("B"=X,"SumA"=Yuppersquare,"color"="red"))
  df<-rbind(df,data.frame("B"=c(0.4,0.4,Bmaximum,Bmaximum),"SumA"=c(Aminimum,0.94,0.94,Aminimum),"color"="green")) # drawn clockwise from low left corner
  df<-rbind(df,data.frame("B"=c(0.4,0.4,Bmaximum,Bmaximum),"SumA"=c(0.94,Amaximum,Amaximum,0.94),"color"="orange1")) # drawn clockwise from low left corner
  return(df)
}

#' @title Draw precautionary diagram itself
#' @param precodata data.frame with column being: eel_emu_nameshort	bcurrent	bbest	b0	suma, using extract_data("precodata")
#' @examples
#' x11()
#' trace_precodiag(extract_data("precodata))
# TODO: offer the possibility to aggregate by country
trace_precodiag3 = function(precodata, 
                            precodata_choice=c("emu","country","all"), 
                            last_year=TRUE,
                            years,
                            stocking = TRUE,
                            bwithout_replace = FALSE)
{  
  bcurr <- "bcurrent_without_stocking"
  if (stocking) bcurr <- "bcurrent"
  ###############################
  # Data selection
  # this in done on precodata which is filtered by the app using filter_data
  #############################
  precodata$last_year[is.na(precodata$last_year)] <- precodata$eel_year[is.na(precodata$last_year)]
  if (last_year) precodata <- precodata[precodata$last_year==precodata$eel_year ,]
  precodata <- precodata %>%
    filter(eel_year %in% years)
  
  if (length(precodata_choice) >1 ) title= "Precautionary diagram" else
    switch(precodata_choice,
           "emu"={title <- "Precautionary diagram for emu"},
           "country"={title <- "Precautionary diagram for country"},
           "country_bis"={title <- "Precautionary diagram for country"},
           "all"={title <- "Precautionary diagram for all countries"},
    )
  
  precodata<-unique(precodata[precodata$aggreg_level%in%precodata_choice,])
  ############################
  # Data for buble plot 
  ############################
  mylimits=c(0,1000)
  precodata$pSpR=exp(-precodata$suma)
  precodata$pbiom=precodata$ratio_bcurrent_b0 <- precodata[, bcurr]/precodata$b0
  precodata$type <- bcurr
  if (bwithout_replace){
    precodata$type <- ifelse(is.na(precodata$pbiom),
                            "bcurrent_without_stocking",
                             precodata$type)
    precodata$pbiom <- ifelse(is.na(precodata$pbiom),
                              precodata[,"bcurrent_without_stocking"]/precodata$b0,
                              precodata$pbiom)
    
    
  }
  if (any(precodata[, bcurr]>precodata$b0,na.rm=TRUE)){
    message("You  have Bbest larger than B0, you should check \n")
    Bmaximum<-max(precodata$pbiom,na.rm=TRUE)
  } else Bmaximum=1
  if (any(is.na(precodata$b0))) message("Be careful, at least some B0 are missing")
  if (max(precodata$bbest,na.rm=TRUE)>mylimits[2]) mylimits[2]<-max(precodata$bbest,na.rm=TRUE)
  if (all(is.na(precodata$pbiom))|all(is.na(precodata$pSpR))) errortext<-"Missing data" else errortext<-""
  df<-background2(Aminimum=0,Amaximum=5,Bminimum=exp(-5),Bmaximum=Bmaximum)
  ######################
  # Drawing the graphs
  ############################
  # If EMU only show labels
  if (length(precodata_choice)==1){    
    choose_label_for_plot <- rep(TRUE,length(precodata))
    choose_color <- "eel_year"
    
    
  } else {
    
    choose_label_for_plot <- precodata$aggreg_level != "emu"
    choose_color <- "aggreg_level"
  }
  precodata$eel_year <- as.factor(precodata$eel_year)
  if (precodata_choice == "emu"){
    labels <- precodata$eel_emu_nameshort
  } else {
    labels <- precodata$eel_cou_code
  }
  g<- ggplot(df)+
    theme_bw()+
    theme(legend.key = element_rect(colour = "white"))+
    geom_polygon(aes(x=B,y=SumA,fill=color),alpha=0.7)+
    scale_fill_identity(labels=NULL)+
    scale_x_continuous(name=expression(paste(bold("Spawner escapement")~ ~over(B,B0))),
                       limits=c(Bminimum, Bmaximum),trans="log10",
                       breaks=c(0.005,0.01,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1),
                       labels=c("","1%","5%","10%","","","40%","","","","","","100%"))+ 
    scale_y_continuous(name=expression(paste(bold("Lifetime mortality")~ ~symbol("\123"),"A")),
                       limits=c(Aminimum, Amaximum)) +
    #geom_path(data = precodata,aes(x = pbiom, y = suma, group = eel_cou_code))+
    #scale_color_discrete(#guide = 'none'
    #    ) +
    geom_point(data=precodata,aes(x=pbiom,y=suma,size=bbest/1000,color=.data[[choose_color]]), alpha=0.7)
  
  if (bwithout_replace) {
    g <- g + geom_point(data=precodata |> filter(type == "bcurrent_without_stocking"),aes(x=pbiom,y=suma,size=bbest/1000), shape = 1)
  }
    
    
  g <- g +
    geom_text_repel(data=precodata, aes(x=pbiom,
                                        y = suma,
                                        size=12,
                                        label = labels#,
                                        #size=bbest/8
    ),
    show.legend = FALSE      
    )+
    scale_size(name="B best (tonnes)",range = c(1, 12.5),limits=c(0,max(pretty(precodata$bbest/1000))))+
    annotate("text",x =  1, y = 0.92, label = "0.92",  parse = F, hjust=1,vjust=-1.1, size=3)+
    annotate("text",x =  1, y = 0.92, label = "Amgt",  parse = F, hjust=1,vjust=1.1, size=3)+
    annotate("text",x =  0.4, y = 0, label = "Bmgt",  parse = F, hjust=0,vjust=-0.7, size=3,angle=90)+
    annotate("text",x =  0.4, y = 0, label = "Btrigger",  parse = F, hjust=0,vjust=1.1, size=3,angle=90)+
    #annotate("text",x =  0.1, y = 2, label = errortext,  parse = F, hjust=1,vjust=1, size=5,col="white")+
    annotate("text",x =  Bminimum, y = 0, label = "100% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 1.2, label = "30% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 1.6, label = "20% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 2.3, label = "10% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 2.99, label = "5% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 4.6, label = "1% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = Amaximum, label = "%SPR",  parse = F, hjust=1,vjust=-3,size=3,angle=90)+               
    ggtitle(str_c(title))
  if(pretty(max(precodata$suma,na.rm=TRUE))[2] > 4.6)   g = g +annotate("text",x =  Bminimum, y = 4.6, label = "1%",  parse = F, hjust=1, size=3) 
  if (choose_color == "eel_year")
    g <- g+scale_colour_viridis("year", discrete=TRUE) else
      g <- g+scale_colour_brewer(palette = "Set3",direction=-1)
  
  
  return(g)
}


```

# Tor b) Evaluate the overall effectiveness of EMPs in terms of trends (or recent changes) in achieving specific target indicators

```{r}
#| label: trendtables
#| echo: false
#| include: false
sumftab <- trendtable(ind = "sumf")
sumhtab <- trendtable(ind = "sumh")
sumatab <- trendtable(ind = "suma")
biomasstrendtab <- trendtable(ind = "bcurrent")
```

## Changes in achieving specific target indicators

### Escapement indicators

#### Possibility to achieve the management target given current recruitment levels

The Eel Regulation states that Eel Manangement Plans should enforce measures to reduce all sources of anthropogenic mortalities in their waterbodies in order to achieve an escapement of at least 40% of the escapement that would occur in a pristine situation. Theoretically, in a pristine situation, the absence of anthropogenic pressures for many generations leads the population to an equilibrium in which, on average, the escapement $B_0$ produces a recruitment $R_0$. Of course, given the current depletion of the population [@dekker2003] and of the recruitment [@ices2024], current levels of recruitment are far below $R_0$ and it is questionable whether it is still possible to achieve the management target without first rebuilding recruitment.

In a pristine situation, and assuming an average natural mortality over the lifespan, escapement in an EMU $e$ can be calculated as:

$$
B_0(e) = \frac{w_S(e)}{w_G(e)} \cdot R_0(e) \cdot e^{-M_0(e) \cdot \Delta t(e)}
$${#eq-b0}

with $\Delta t(e)$ the lifespan, $M_0(e)$ the average natural mortality, $w_G$ and $w_S$ the average weight of glass and silver eels, and $R_0(e)$ the recruitment in the pristine situation in the corresponding EMU.

Conversely, in the absence of any anthropogenic mortalities, current escapement can be calculated in an EMU as:

$$
B(e) = \frac{w_S(e)}{w_G(e)} \cdot R(e) \cdot e^{-M(e) \cdot \Delta t(e)}
$$ {#eq-b}

On average, current recruitment is estimated to be less than 10% of what it was in the pre-1980s [@ices2024]. In this context, if the lifespan has remained the same, having $B(e)/B_0(e)$\>40% while $R(e)/R_0(e)$\<10% would require a drop of the natural mortality. This might occur as a result of compensatory density dependence mechanisms [@bevacqua2011], but what would be the required decrease of natural mortality?

To achieve the target, assuming the lifespan hasn't changed, we need:

$$
\begin{split}
&\frac{B(e)}{B_0(e)} \geq 0.4 \\
& \Leftrightarrow \frac{\frac{w_S(e)}{w_G(e)} \cdot R(e) \cdot e^{-M(e) \cdot \Delta t(e)}}{\frac{w_S(e)}{w_G(e)} \cdot R_0(e) \cdot e^{-M_0(e) \cdot \Delta t(e)}} \geq 0.4 \\
& \Leftrightarrow e^{(M_0(e)-M(e)) \cdot \Delta t(e)} \geq 0.4 \cdot \frac{R_0(e)}{R(e)}\\
& \Leftrightarrow (M_0-M) \cdot \Delta t \geq log \left( 0.4 \cdot \frac{R_0(e)}{R(e)} \right) \\
& \Leftrightarrow (M_0(e)-M(e)) \geq  \frac{1}{\Delta t(e)}log \left( 0.4 \cdot \frac{R_0(e)}{R(e)} \right)
\end{split}
$$

The last equation indicates the reduction of natural mortality that would be required to achieve the target in the absence of anthropogenic mortality, given current levels of recruitment. $\frac{R_0(e)}{R(e)}$ is the ratio of pristine recruitment over current recruitment. Since recruitment trends are thought to be homogeneous across the distribution area, this ratio can be compared to the WGEEL indices.

Since lifespans vary among regions from a few years to decades and since the recruitment might still locally vary, we computed $\frac{1}{\Delta t(e)}log \left( 0.4 \cdot \frac{R_0(e)}{R(e)} \right)$ for different levels of $\Delta t(e)$ and $\frac{R(e)}{R_0(e)}$.

Figure `r run_reference("fignatmort")` indicates that for lifespans shorter than 15 years, the reduction of natural mortality should be larger than 0.138 year^-1^, a value often used for the eel [@dekker2000]. The situation is of course even worse if considering the North Sea index rather than the Elsewhere Europe index. Even at very long lifespan (30 years), the natural mortality should be reduced by 0.05 year^-1^ (i.e. a reduction of M of about 36% compared to the standard 0.138 year^-1^ value) when assuming that current recruitment is 8% of pristine recruitment (\~ what Elsewhere Europe index indicates). This reduction is the average value over the whole lifespan of the individual, while density-dependent natural mortality is mainly restricted to younger ages.



```{r plot}
#| echo: false
#| warning: false
#| error: false
#| fig.height: 6.3
#| fig.width: 6.3


library(tidyr)
library(dplyr)
rec = read.table("../../R/recruitment/2024/data/glm_results_glass.csv",
                 header = TRUE,
                 sep = ";")

rec <- rec %>% 
  select(all_of(c("year","Elsewhere.Europe","North.Sea"))) %>%
  pivot_longer(all_of(c("Elsewhere.Europe","North.Sea")), 
               names_to = "area", 
               values_to = "RR0") %>%
  mutate(lifespan = 2024 - year) 
  


rr0=exp(seq(log(0.001), log(0.4), length.out = 100))
lifespan=seq(5,30,5)
comb = expand.grid(RR0=rr0, lifespan=lifespan)
comb$values =mapply(function(r, dt){
  1/dt * log(0.4/r)
}, r=comb$RR0,dt=comb$lifespan)
library(ggplot2)
g = ggplot(comb, aes(x=RR0, y=values)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~lifespan)+
  xlab(expression(R(e)/R[0](e))) +
  ylab(expression(M~reduction~(year^-1))) +
  geom_hline(aes(yintercept = 0.138), col=2)+
  geom_vline(data = rec %>%
              filter(lifespan %in% comb$lifespan), 
            aes(xintercept= RR0, lty = area),
            inherit.aes = FALSE) +
  scale_linetype_manual("area", values = c("Elsewhere.Europe"=3,
                                           "North.Sea"=4))+
  xlim(0,0.4) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave(file.path(params$image_path,"mortality_1.png"), width=16/2.54,height=16/2.54)
knitr::include_graphics(file.path(params$image_path,"mortality_1.png"))

```

::: {custom-style="Image Caption"}
Figure `r run_bookmark("fignatmort", runs_figure)`: Reduction of average natural mortality over the lifespan that would be required to achieve the management target in an  EMU given different levels of recruitment (x-axis) and lifespan (facet). The two vertical lines indicate the recruitment estimates from the WGEEL glass eel indices lagged according to the lifespan (i.e. lines for lifespan 5 corresponds to the recruitment estimates in 2024-5=1999). The horizontal line corresponds to a natural mortality of 0.138 year^-1^.
:::

#### Reported time series of escapement

Figure `r run_reference("figtrendbiomass")` and Table `r run_reference("tbl-trendbiomass")` show the time series of reported escapement. Given the uncertainty and inconsistencies in the estimation of $B_0$, the trend is likely to be more reliable than the absolute value. We observe for example that in some EMUs $B_{current}$/$B_0$ is above 40% before the implementation of EMPs, despite the low recruitments in the late 2000s, questioning the estimates of $B_0$. In each EMU, a Mann-Kendall trend test was used to test for the existence of a significant monotonic time trend. Some negative significant trends in escapement are still detected (Table `r run_reference('tbl-trendbiomass')`), which might be due to a delayed effect of the decline in recruitment.


```{r}
#| echo: false
#| fig-height: 6.3
#| fig-width: 6.3

if (!dir.exists(file.path(params$image_path,"trendbiomassplots"))) {
  dir.create(file.path(params$image_path,"trendbiomassplots"))
}
indicator <- precodata_all |>
  filter(aggreg_level == "emu")
indicator <- indicator %>%
  mutate(eel_cou_code = ifelse(eel_cou_code == substr(eel_emu_nameshort, 1, 2),
                               eel_cou_code,
                               "INT"
  )) %>%
  filter(eel_cou_code %in% eu_cou_codes)


g <- ggplot(indicator %>% filter(!is.na(bcurrent / b0)), aes(x = eel_year, y = bcurrent / b0)) +
  geom_hline(yintercept = .4, col = "red") +
  geom_line(aes(col = eel_cou_code, group = eel_emu_nameshort)) +
  #  scale_y_log10()+
  scale_color_manual("country", values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)], ) +
  guides(lty = FALSE, col = FALSE) + # geom_hline(yintercept=1)+
  #  scale_y_sqrt()+
  
  theme_bw() +
  ylab(expression(B[current] / B[0])) +
  xlab("") +
  xlim(2007, 2023) +
  facet_wrap(~eel_cou_code, drop = TRUE, scales = "free_y")

ggsave(g, filename = file.path(params$image_path,"trend_biomass.png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trend_biomass.png"))

for (emu in unique(indicator$eel_emu_nameshort)) {
  g <- ggplot(
    indicator %>% filter(!is.na(bcurrent / b0) &
                           eel_emu_nameshort == emu),
    aes(x = eel_year, y = bcurrent / b0)
  ) +
    geom_hline(yintercept = .4, col = "red") +
    geom_line(aes(col = eel_cou_code, group = eel_emu_nameshort)) +
    #  scale_y_log10()+
    scale_color_manual("country", values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)], ) +
    guides(lty = FALSE, col = FALSE) + # geom_hline(yintercept=1)+
    #  scale_y_sqrt()+
    
    theme_bw() +
    ylab(expression(B[current] / B[0])) +
    xlab("") +
    xlim(2007, 2023) +
    ggtitle(emu)
  
  ggsave(g, filename = paste0(file.path(params$image_path,"trendbiomassplots/trend_biomass_"), emu, ".png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
}
```

::: {custom-style="Table Caption"}
Figure `r run_bookmark("figtrendbiomass", runs_figure)`: Time series of reported $B_{current}/B_0$. Each coloured line represents a specific EMU. The horizontal red line indicates the 40% target according to the Eel Regulation.
:::


<br>

::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-trendbiomass", runs_table)`: Results of Mann-Kendall test for monotonic trends per EMU for $B_{current}$ (kg). 'n' represents the number of years for which estimates are available, while Δ is the difference between the first and the last reported values. Tau represents the direction of the trend (positive = increase, negative = decrease) and p-values indicate the significance of the trend. Trend indicates the detection of a significant increasing (↗) or decreasing trend (↘). Some countries (e.g. NL and FR) report the same value for several yearsand this might affect the results of the trend test.
:::


<br>

```{r}
#| label: flextabletrendbiomass
flextable(biomasstrendtab |>
            mutate(across(all_of(c("Initial","Final","Δ")),round),
                   trend = ifelse(`tau Kendall` < 0 & `p-value Kendall` <= 0.05, 
                                  "↘",
                                  ifelse(`tau Kendall` > 0 & `p-value Kendall` <= 0.05,
                                         "↗",
                                         "")))) |>
  flextable2ICES()# |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`>0,bg="green") |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`<0,bg="red")

```

<br>

The patterns are very similar when $B_{current\_without\_stocking}$ is plotted (Figure `r run_reference("@fig-trendbiomasswithoutstocking")`), with the escapements often shifted downward. This suggests that restocking does not have a major effect on recent trends in escapement.



```{r}
#| fig-height: 6.3
#| fig-width: 6.3
indicator <- indicator %>%
  mutate(eel_cou_code = ifelse(eel_cou_code == substr(eel_emu_nameshort, 1, 2),
                               eel_cou_code,
                               "INT"
  )) %>%
  filter(eel_cou_code %in% eu_cou_codes)


g <- ggplot(indicator %>% filter(!is.na(bcurrent / b0)), aes(x = eel_year, y = bcurrent / b0)) +
  geom_hline(yintercept = .4, col = "red") +
  geom_line(aes(col = eel_cou_code, group = eel_emu_nameshort)) +
  #  scale_y_log10()+
  scale_color_manual("country", values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)], ) +
  guides(lty = FALSE, col = FALSE) + # geom_hline(yintercept=1)+
  #  scale_y_sqrt()+
  
  theme_bw() +
  ylab(expression(B[current_without_stocking] / B[0])) +
  xlab("") +
  xlim(2007, 2023) +
  facet_wrap(~eel_cou_code, drop = TRUE, scales = "free_y")

ggsave(g, filename = file.path(params$image_path,"trend_biomass_without_stocking.png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trend_biomass_without_stocking.png"))
```
::: {custom-style="Image Caption"}
Figure `r run_bookmark("fig-trendbiomasswithoutstocking", runs_figure)` Trends in reported $B_{current\_without\_stocking}/B_0$. Each coloured line represents a specific EMU. The horizontal red line indicates the target according to the Eel Regulation.
:::
### Mortality indicators

#### Fishing mortality

Figure `r run_reference("fig-trendmortasumf")` and Table `r run_reference("tbl-trendsumf")` show the time series of reported fishing mortality per EMU and the results of the Mann-Kendall trend tests.




```{r}
#| fig-height: 6.3
#| fig-width: 6.3
sumf <- ggplot(indicator %>% filter(!is.na(sumf)), aes(x = eel_year, y = sumf)) +
  geom_hline(yintercept = 0.92, col = "red") +
  geom_line(aes(group = eel_emu_nameshort, col = eel_cou_code)) +
  scale_color_manual(values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)]) +
  guides(lty = FALSE, col = FALSE) +
  #  scale_y_sqrt()+
  theme_bw() +
  ylab(expression(Sigma~F~(year^{-1}))) +
  xlab("") +
  xlim(2007, 2023) +
  facet_wrap(~eel_cou_code, drop = TRUE, scales = "free_y")

ggsave(sumf, file = file.path(params$image_path,"trend_sumf.png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trend_sumf.png"))
```

::: {custom-style="Image Caption"}
Figure `r run_bookmark("fig-trendmortasumf", runs_figure)`: Time series of reported ΣF. Each coloured line represents a specific EMU. The red horizontal line stands for the 0.95 year^{-1} limit.
:::


::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-trendsumf", runs_table)`: Results of Mann-Kendall test for monotonic trends per EMU for sumF ($year^{-1}$). 'n' represents the number of years for which estimates are available, while Δ is the difference between the first and the last reported values. Tau represents the direction of the trend (positive = increase, negative = decrease) and p-value indicates the significance of the trend. Trend indicates the detection of a significant increasing (↗) or decreasing trend (↘). Some countries (e.g. NL and FR) report the same value for several yearsand this might affect the results of the trend test.
:::


<br>

```{r}
#| label: flextabletrendsumf
flextable( sumftab |>
             mutate(across(all_of(c("Initial","Final","Δ")), ~round(.x, digits = 2)),
                   trend = ifelse(`tau Kendall` < 0 & `p-value Kendall` <= 0.05, 
                                  "↘",
                                  ifelse(`tau Kendall` > 0 & `p-value Kendall` <= 0.05,
                                         "↗",
                                         "")))) |>
  flextable2ICES()# |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`>0,bg="green") |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`<0,bg="red")
```

<br>

Interestingly, the reduction in fishing mortality is more visible than the increase in escapement, with `r sum(sumftab[,8]<0.05 & sumftab[,7]<0, na.rm = TRUE)` EMUs displaying a significant decrease. However, `r sum(sumftab[,8]<0.05 & sumftab[,7]>0, na.rm = TRUE)` are still displaying a significant increase of fishing mortality, while the vast majority show no trend.

#### Others anthropogenic mortalities

Figure `r run_reference("fig-trendmortasumh")` and Table `r run_reference("tbl-trendsumh")` show the time series of reported other anthropogenic mortalities and the results of the Mann-Kendall trend tests. In many EMUs, $\sum H$ is very small or equal to zero suggesting that only a part of the mortalities is accounted for. 

```{r}
#| fig-height: 6.3
#| fig-width: 6.3
sumh <- ggplot(indicator %>% filter(!is.na(sumh)), aes(x = eel_year, y = sumh)) +
  geom_hline(yintercept = 0.92, col = "red") +
  geom_line(aes(group = eel_emu_nameshort, col = eel_cou_code)) +
  scale_color_manual(values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)]) +
  guides(lty = FALSE, col = FALSE) +
  #  scale_y_sqrt()+
  theme_bw() +
  ylab(expression(Sigma~H~(year^{-1}))) +
  xlab("") +
  xlim(2007, 2023) +
  facet_wrap(~eel_cou_code, drop = TRUE, scales = "free_y")

ggsave(sumh, file = file.path(params$image_path,"trend_sumh.png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trend_sumh.png"))
```
::: {custom-style="Image Caption"}
Figure `r run_bookmark("fig-trendmortasumh", runs_figure)`: Time series of reported ΣH. Each coloured line represents a specific EMU. The red horizontal line stands for the 0.95 year^{-1} limit.
:::


<br>


::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-trendsumh", runs_table)`: Results of Mann-Kendall test for monotonic trends per EMU for sumH ($year^{-1}$). 'n' represents the number of years for which estimates are available, while Δ is the difference between the first and the last reported values. Tau represents the direction of the trend (positive = increase, negative = decrease) and p-value indicates the significance of the trend. Trend indicates the detection of a significant increasing (↗) or decreasing trend (↘). Some countries (e.g. NL and FR) report the same value for several yearsand this might affect the results of the trend test.
:::

<br>

```{r}
#| label: flextabletrendsumh
flextable( sumhtab |>
             mutate(across(all_of(c("Initial","Final","Δ")),~round(.x, digits = 2)) ,
                   trend = ifelse(`tau Kendall` < 0 & `p-value Kendall` <= 0.05, 
                                  "↘",
                                  ifelse(`tau Kendall` > 0 & `p-value Kendall` <= 0.05,
                                         "↗",
                                         "")))) |>
  flextable2ICES()# |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`>0,bg="green") |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`<0,bg="red")

```

<br>

`r sum(sumhtab[,8]<=0.05 & sumhtab[,7]<0, na.rm = TRUE)` EMUs displaying a significant decrease of $\sum H$, another `r sum(sumhtab[,8]<0.05 & sumhtab[,7]>0, na.rm = TRUE)` display a significant increase, but the vast majority show no trend.
The Workshop was asked to provide further insights on trends per mortality types (e.g. hydropower, contamination). However, given that (i) the number of significant trends for the combined "others anthropogenic mortalities" indicators is very small (Table `r run_reference("tbl-trendsumh")`) and (ii) that it is unclear which mortalities were accounted for in the different EMUs (and many of them were seemingly not accounted for at all), the experts were not in position to answer precisely the request but consider that reported trends in $sumH$ did not indicate a likely change in any other types of mortalities.

#### Total anthropogenic mortality
Figure `r run_reference("fig-trendmortasuma")` and Table `r run_reference('tbl-trendsuma')` show the reported times series of reported total anthropogenic mortalities and the results of the Mann-Kendall trend tests.

```{r}
#| fig-height: 6.3
#| fig-width: 6.3
suma <- ggplot(indicator %>% filter(!is.na(suma)), aes(x = eel_year, y = suma)) +
  geom_hline(yintercept = 0.92, col = "red") +
  geom_line(aes(group = eel_emu_nameshort, col = eel_cou_code)) +
  scale_color_manual(values = color_countries[names(color_countries) %in% unique(indicator$eel_cou_code)]) +
  guides(lty = FALSE, col = FALSE) +
  #  scale_y_sqrt()+
  theme_bw() +
  ylab(expression(Sigma~A~(year^{-1}))) +
  xlab("") +
  xlim(2007, 2023) +
  facet_wrap(~eel_cou_code, drop = TRUE, scales = "free_y")

ggsave(suma, file = file.path(params$image_path,"trend_suma.png"), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trend_suma.png"))
```


::: {custom-style="Image Caption"}
Figure: `r run_bookmark("fig-trendmortasuma", runs_figure)`: Time series of in reported ΣA. Each coloured line represents a specific EMU. The red horizontal line stands for the 0.95 year^{-1} limit.
:::

<br>


::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-trendsuma", runs_table)`: Results of Mann-Kendall test for monotonic trends per EMU for sumA ($year^{-1}$). 'n' represents the number of years for which estimates are available, while Δ is the difference between the first and the last reported values reported. Tau represents the direction of the trend (positive = increase, negative = decrease) and p-value indicates the significance of the trend. Trend indicates the detection of a significant increasing (↗) or decreasing trend (↘). Some countries (e.g. NL and FR) report the same value for several yearsand this might affect the results of the trend test.
:::


<br>

```{r}
#| label: flextabletrendsuma 
flextable( sumatab |>
             mutate(across(all_of(c("Initial","Final","Δ")),~round(.x, digits = 2)),
                   trend = ifelse(`tau Kendall` < 0 & `p-value Kendall` <= 0.05, 
                                  "↘",
                                  ifelse(`tau Kendall` > 0 & `p-value Kendall` <= 0.05,
                                         "↗",
                                         "")))) |>
  flextable2ICES()# |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`>0,bg="green") |>
  #bg(i=~`p-value Kendall`<=0.05 & `tau Kendall`<0,bg="red")

```

<br>

Total anthropogenic mortalities is the sum of fishing and other anthropogenic mortalities, therefore it is not surprising to observe similar patterns to the Fishing and Non-Fishing Mortality indicators.

### Precautionary diagram

Precautionary diagrams were proposed by ICES [@ices2010] to provide an overview of the achievement of the Eel Regulation objectives, potentially by EMUs or countries. The diagram concept shows the ratio of the current escapement over pristine biomass $B_0$ on x-axis, with a threshold $B_{mgt}$ set at 40% and corresponding to the Regulation target. On the y-axis, reported anthropogenic mortalities $sumA$ are reported, with a threshold set at 0.92 year^-1^ which corresponds to the cumulative lifespan mortality that would allow the achievement of 40% of $B_{best}$. The data reported by Member States are reported at the EMU scale. Aggregations at the country scale were achieved following the methods described in @ices2010.

Precautionary diagrams are valuable for a simple exploration of the status of the population across EMUs or countries. However, they suffer from the lack of standardisation in assessment methods and especially from inconsistencies in the estimation of $B_0$. Therefore, comparisons among EMUs/countries are difficult and the comparison with $B_{mgt}$ is greatly affected by inconsistencies in the estimation of $B_0$. As such, trend analysis of indicators is thought to be more reliable and therefore more informative.

Here, we will focus on the precautionary diagram at the EMU scale since (i) it is the scale at which data are reported and (ii) aggregation at the country scale is sensitive to missing data. The diagram at the country scale can be found in annex XX.

Few EMUs are in the green area, i.e. have both achieved the management target and reduced the anthropogenic mortality below 0.92 year^-1^ (Figure `r run_reference("fig-precoemu")` - Table `r run_reference("tbl-precoemu")`). While caution should be taken with the estimate of $B_0$ and therefore with the achievement or not of the 40% target, a few EMUs are in reported to be in the green zone. In Ireland, the fishery ban has effectively reduced the anthropogenic mortality. A few other areas are in the green area. In EE_Narv, the natural recruitment is thought to be insignificant so the situation only relies on the artificial restocking. The situation is the same (or almost the same) in German EMUs or in PL_Oder in which escapement largely relies on restocking.

Many EMUs are still in the red zone. While not achieving the 40% pristine escapement is not surprising given the current low recruitment levels, it indicates that anthropogenic mortalities have not been reduced enough yet to achieve an escapement of 40% of what would occur given current level of recruitment in the absence of any anthropogenic pressures.

```{r}
#| message: false
#| warning: false
#| echo: false
#| fig-width: 6.3
#| fig-height: 3.94
#|
img <- file.path(params$image_path,"preco_emu.png")
g = trace_precodiag3(precodata_all,"emu",last_year=2023,years=2021:2023, bwithout_replace = TRUE)
ggsave(img, height = 12/2.54, width = 16/2.54)
knitr::include_graphics(img)


```
::: {custom-style="Image Caption"}
Figure `r run_bookmark("fig-precoemu", runs_figure)`: Precautionary Diagram for Eel Management Units (ICES 2021b), presenting the reported data for 2021, 2022 and 2023: status of the stock (horizontal, spawner escapement ($B_{current}$) expressed as a percentage of the pristine escapement ($B_0$)) and the anthropogenic impacts (vertical, expressed as lifetime mortality ΣA, resp. lifetime survival %SPR). The limit anthropogenic mortality (Amgt) was set as 0.92, corresponding to the 40% biomass limit (B mgt). Points circled with black stand for EMU in which $B_{current\_without\_stocking}$ was used to replace missing $B_{current}$.
:::


<br>

::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-precoemu", runs_table)`: Position of EMUs in the precautionary diagram. The colours stand for the zones in the diagram. A "x" indicates that $B_{current\_without\_stocking}$ was used to replace missing $B_{current}$.
:::

<br>

```{r}
#| label: flextableprecoemu
f <- precodata_all |>
  filter(aggreg_level == "emu",
         eel_year %in% 2021:2023) |>
  mutate(isbtarget = (ifelse(is.na(bcurrent), bcurrent_without_stocking, bcurrent)/b0)>=0.4,
         issum = suma <=0.92,
         replace = ifelse(is.na(bcurrent) & !is.na(bcurrent_without_stocking), "x", "")) |>
  mutate(zone = isbtarget + issum) |>
  select(eel_cou_code,eel_emu_nameshort,eel_year,zone,replace) |>
  filter(!is.na(zone)) |>
  pivot_wider(id_cols = all_of(c("eel_cou_code","eel_emu_nameshort")),
              names_from = eel_year,
              values_from = c(zone,replace)) |>
  arrange(eel_cou_code,eel_emu_nameshort) |>
  rename(Country = eel_cou_code,
         EMU = eel_emu_nameshort) |>
  rename_with(~gsub("replace_", "", .x)) |>
  flextable()


for (i in 2021:2023){
  f <- f |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("zone",
                                              as.character(i),
                                              sep = "_"),
                                        "== 0")),
                  j = as.character(i), 
                  part = "body", 
                  bg="red") |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("zone",
                                              as.character(i),
                                              sep = "_"),
                                        "== 1")),
                  j = as.character(i), 
                  part = "body", 
                  bg="orange") |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("zone",
                                              as.character(i),
                                              sep = "_"),
                                        "== 2")),
                  j = as.character(i), 
                  part = "body", 
                  bg="green")
  
  
}
f |>
  flextable::delete_columns(j=paste("zone",
                                    2021:2023,
                                    sep = "_")) |>
  flextable::merge_v(j = 1, part = "body") |>
  flextable2ICES()



```

<br>


::: {custom-style="Image Caption"}
Table `r run_bookmark("tbl-precoemudetail", runs_table)`: Achievement of Eel Regulation target and of mortality reduction. A green background indicates that $B_{current}/B_0 \geq 40\%$ or that $\sum A \leq 0.92$ year^{-1}. A grey background indicates missing data. A "x" indicates that $B_{current\_without\_stocking}$ was used to replace missing $B_{current}$.
:::

<br>

```{r}
#| label: flextableprecoemudetail
f <- precodata_all |>
  filter(aggreg_level == "emu",
         eel_year %in% 2021:2023) |>
  mutate(biomass = (ifelse(is.na(bcurrent), bcurrent_without_stocking, bcurrent)/b0)>=0.4,
         mortality = suma <=0.92,
         replace = ifelse(is.na(bcurrent) & !is.na(bcurrent_without_stocking), "x", "")) |>
  select(eel_cou_code,eel_emu_nameshort,eel_year,replace, mortality, biomass) |>
  filter(!(is.na(mortality) & is.na(biomass))) |>
  pivot_wider(id_cols = all_of(c("eel_cou_code","eel_emu_nameshort")),
              names_from = eel_year,
              values_from = c(biomass, mortality, replace)) |>
  arrange(eel_cou_code,eel_emu_nameshort) |>
  rename(Country = eel_cou_code,
         EMU = eel_emu_nameshort) |>
  flextable()


for (i in 2021:2023){
  f <- f |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("mortality",
                                              as.character(i),
                                              sep = "_"),
                                        "== TRUE")),
                  j = as.character(paste("mortality",
                                              as.character(i),
                                              sep = "_")), 
                  part = "body", 
                  bg="green") |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("is.na(mortality",
                                              as.character(i),
                                              sep = "_"),
                                        ")")),
                  j = as.character(paste("mortality",
                                              as.character(i),
                                              sep = "_")), 
                  part = "body", 
                  bg="grey") |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("biomass",
                                              as.character(i),
                                              sep = "_"),
                                        "== TRUE")),
                  j = as.character(paste0("replace_",i)), 
                  part = "body", 
                  bg="green") |>
    flextable::bg(i = as.formula(paste0("~",
                                        paste("is.na(biomass",
                                              as.character(i),
                                              sep = "_"),
                                        ")")),
                  j = as.character(paste0("replace_",i)), 
                  part = "body", 
                  bg="grey")
  
  
}

newnames <- as.character(c(2021:2023, 2021:2023))

names(newnames) <- c(paste0("mortality_", as.character(2021:2023)),
                     paste0("replace_", as.character(2021:2023)))
extra_header <- c(rep("mortality",3), rep("biomass", 3))
names(extra_header) <- names(newnames)

f |>
  flextable::void(paste("mortality", 2021:2023, sep = "_")) |>
  flextable::merge_v(j = 1, part = "body") |>
  flextable::add_header_row(values = c("", "mortality", "biomass"),
                            colwidths = c(5,3,3)) |>
    flextable::delete_columns(j=paste("biomass",
                                    2021:2023,
                                    sep = "_")) |>
  flextable::set_header_labels(values = as.list(newnames)) |>
  flextable::merge_h(part = "header") |>
  flextable2ICES()



```

### Conclusions

As during most recent WKEMP report [@ices2022], the caveats associated with the estimation of the different indicators and the lack of standardised methods among countries, hinder the comparison of escapement and mortalities among countries and with respect to the management target and mortality reference value. Moreover, a simulation exercise confirms that the current low recruitment all over the distribution area, drastically reduces the possibility to achieve the 40% escapement target of the Eel Regulation, in any EMUs. This would require either an unlikely reduction of natural mortality that density-dependent effects are not likely to explain or favourable local conditions of recruitement while recruitment trends are thought to be rather homogeneous other the distribution area. Following @ices2022, we consider that trends are more reliable since methods used by countries are consistent through time. The escapement appears to be still declining, but this is not surprising given the delayed effect of declines in recruitment. Compared to @ices2022, significant negative trends in anthropogenic mortalities are more frequent, suggesting an improvement in the situation. However, we still observe some increasing trends and some levels of fishing mortality that are of the same order of magnitude as the 0.92 year^-1^ limit, even in countries in which escapement relies mainly on restocking. Reported values of other anthropogenic mortalities are smaller, but those estimates only account for a limited part of the stressors thought to apply to these areas.

Implementing the WKFEA roadmap [@ices2021] is critical to achieving or delivering more standardised methods and more informative results in the future.

## Small eel usage
The traceability of glass eel landings and of their subsequent trade are crucial for legal enforcement, conservation, population recovery, and adherence to international conservation agreements. The European eel regulation requires monitoring of glass eels (those under 12 cm) designated for restocking as well as those for consumption. It also mandates that EMPs specify the quantity of eels under 20 cm needed for restocking to enhance silver eel escapement levels. It is necessary to identify whether the eels are destined for restocking (R) or consumption (C). The consumption category encompasses both glass eels directly consumed and those raised in aquaculture for later consumption as adults.

<br>
Among the glass eel producing countries of Europe, France monitors the RC category using a quota system, the UK monitors trade but has left the EU so does not take part in this reporting, Portugal has not reported any data, and Spain has no specific traceability system for glass eels, and a general system applied to all fishery products that does not allow the use (R or C)  and country of destination to be identified. In France, quotas are divided among commercial fishers and other users, with a portion often designated for restocking purposes. Although France has an internal traceability system to follow the use of the glass eels landings, once they leave the country, the use for which they were exported (restocking or consumption) cannot be guaranteed. Ensuring this would require tracing the glass eels until they are released into the water in the glass eel source country or in others.

Among the receiving countries, the Netherlands, Finland, Greece, Poland, the Czech Republic, and Sweden report import and export data, including the RC category. The Netherlands have reported the import of glass eels from Spanish traders, but since Spain is lacking a traceability system, this does not necessarily imply that the glass eels were caught in Spain. Greece also claims to import glass eel for stocking from Spain, but notes that the glass eels come from France. This could be explained by the fact that Spanish traders import glass eels from France.

<br>
Belgium, Germany, Italy, Latvia, and Lithuania did not report Annex 16, (or reported it empty), while Latvia states it does not use small eels but engages in restocking. Denmark reports the  kilograms of eels used for aquaculture pre-growing for restocking, trade exports, and aquaculture consumption; but  does not specify the countries of origin or destination.. Albania, Turkey, Tunisia, and Norway do not use restocking or aquaculture and thus did not report.
<br>

There is a clear need for an international traceability scheme during trade to monitor the destination of caught glass eels. Spain’s failure to monitor the destination of glass eels and Portugal’s lack of reporting mean that traceability cannot be applied at the source. The failure of any country (Belgium, Germany, Italy, Latvia, Lithuania, Denmark) to monitor trade origin, destination, or RC category means it is currently impossible to track the destination of glass eels.
The use of size categories like 12 cm and 20 cm is confusing. Reports of 20 cm eels are inconsistent, with some countries reporting trade of larger eels but not in the 20 cm category. Due to significant growth variation in eels, separating them by size has little biological basis and quickly mixes different cohorts. Only the separation of glass eels and other categories should be used practically.

<br>
Even when RC categories are reported, they are not traced or separated, making it impossible to ensure that glass eels reserved for restocking are used for that purpose. Also, not having different categories for directly consumed glass eels or those used in the aquaculture complicates the tracking and management of eel stocks. Without clear categorization, there is a risk that eels meant for conservation efforts, such as restocking programs, could be diverted to the consumption or aquaculture markets. Additionally, combining these eels in one category can lead to inaccuracies in data on catch volumes and trade. Categorizing them separately, could improve traceability and ensure that eels destined for restocking programs are not diverted for other uses. 

<br>
Finally, the lack of effective traceability severely impairs accurate eel stock assessments. Without it, data on catch volumes, origins, and destinations are unreliable, complicating efforts to estimate true fishing pressure and mortality rates. This gap not only weakens scientific assessments but also hinders conservation efforts, as much of the catch and trade may go unreported, often due to illegal fishing. Traceability is also essential for assessing the effectiveness of restocking programs and their impact on biomass indicators. 
In conclusion, the glass eel traceability system in Europe is inefficient and fragmented:
-	Some countries have reported internal traceability systems, but there is no traceability at the transnational level.
-	The lack of transnational traceability raises concerns about the actual use of these eels, especially for restocking purposes.
-	The size categories (<12 cm and 20 cm) lack a strong biological basis, as growth variations among eels make them difficult to classify. Only the separation of glass eels from other types should be considered in practice.
-	The lack of effective traceability severely impairs accurate eel stock assessments.

<b>
Recommendation:
-	Implementing a mandatory transnational traceability system to track eels from capture to their final destination to ensure the compliance with environmental regulations and international treaties and a proper stock assessment. In the case of restocked eels, this means until they are released into the water to avoid that glass eels are diverted to other, potentially illegal, uses.
-	The traceability system should separate glass eels intended for direct consumption from those intended for growing in aquaculture facilities. 

\newpage

::: {custom-style="Annex heading"}
Trends in indicators
:::
# Trends per emu

## Trends in biomass

```{r}
#| label: fig-biomasstrendsemu
#| fig-cap: "Trends in reported Bcurrent/B0. The horizontal red line indicates the target set in the Eel Regulation."
#| fig-height: 6.3
#| fig-width: 6.3

plot_indicator_emu <- function(data = indicator,
                               iemus = 1:16,
                               ind = "bratio",
                               ref = 0.4,
                               ylab = expression(B[current]/B[0])){
  g <- ggplot(
    data %>% filter(!is.na(.data[[ind]]) & iemu %in% iemus),
    aes(x = eel_year, y = .data[[ind]])
  ) +
    geom_hline(yintercept = ref, col = "red") +
    geom_line() +
    #  scale_y_sqrt()+
    
    theme_bw() +
    ylab(ylab) +
    xlab("") +
    xlim(2007, 2023) +
    facet_wrap(~eel_emu_nameshort,
               ncol = 4,
               nrow = 4)
  
}




biomass <- indicator |>
  mutate(bratio = bcurrent/b0) |>
  filter(!is.na(bratio))


emus <- sort(unique(biomass$eel_emu_nameshort))

g <- biomass |>
  mutate(iemu = match(eel_emu_nameshort, emus)) |>
  plot_indicator_emu(1:16)
ggsave(g, filename = paste0(file.path(params$image_path,"trendbiomassplots/trend_biomass_1_16.png")), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trendbiomassplots/trend_biomass_1_16.png"))


```

<br>

::: {custom-style="Image Caption"}

```{r}
#| label: generateemubiom
#| echo: false
#| message: false
#| warning: false
#| output: 'asis'

src <- lapply(2:ceiling(length(emus)/16), function(i){
  imin <- (i-1) *16 +1
  imax <- i * 16
  g <- biomass |>
    mutate(iemu = match(eel_emu_nameshort, emus)) |>
    plot_indicator_emu(imin:imax)
  file <- paste0(file.path(params$image_path,"trendbiomassplots/trend_biomass_"),imin,"_",imax,".png")
  ggsave(g, filename = file, width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
  
  knit_expand(text=c(paste0('![](', file, ')'),
                     '<br>',
                     'Figure @fig-biomasstrendsemu - continue',
                     '<br>',
                     '\\newpage',
                     '\n'))
})
res <- knitr::knit_child(text = src, quiet = TRUE)
cat(res, sep = '\n')
```

:::



## Trends in mortalities

### Trends in fishing mortality

```{r}
#| label: fig-sumftrendsemu
#| fig-cap: "Time series of reported sumF (year^{-1}). The horizontal red line indicates the 0.92 year^{-1} threshold."
#| fig-height: 6.3
#| fig-width: 6.3




sumF <- indicator |>
  filter(!is.na(sumf))


emus <- sort(unique(sumF$eel_emu_nameshort))

g <- sumF |>
  mutate(iemu = match(eel_emu_nameshort, emus)) |>
  plot_indicator_emu(1:16, ind = "sumf", ref = 0.92, ylab = expression(Sigma~F~(year^{-1})))
ggsave(g, filename = paste0(file.path(params$image_path,"trendbiomassplots/trend_sumf_1_16.png")), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trendbiomassplots/trend_sumf_1_16.png"))


```

<br>

::: {custom-style="Image Caption"}

```{r}
#| label: generateemusumf
#| echo: false
#| message: false
#| warning: false
#| output: 'asis'

src <- lapply(2:ceiling(length(emus)/16), function(i){
  imin <- (i-1) *16 +1
  imax <- i * 16
  g <- sumF |>
    mutate(iemu = match(eel_emu_nameshort, emus)) |>
    plot_indicator_emu(iemus = imin:imax,
                       ind = "sumf", 
                       ref = 0.92,
                       ylab = expression(Sigma~F~(year^{-1})))
  file <- paste0(file.path(params$image_path,"trendbiomassplots/trend_sumf_"),imin,"_",imax,".png")
  ggsave(g, filename = file, width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
  
  knit_expand(text=c(paste0('![](', file, ')'),
                     '<br>',
                     'Figure @fig-sumftrendsemu - continue',
                     '<br>',
                     '\\newpage',
                     '\n'))
})
res <- knitr::knit_child(text = src, quiet = TRUE)
cat(res, sep = '\n')
```

:::

### Trends in other anthropogenic mortalities

```{r}
#| label: fig-sumhtrendsemu
#| fig-cap: "Reported time series of reported sumH (year^{-1}). The horizontal red line indicates the 0.92 year^{-1} threshold."
#| fig-height: 6.3
#| fig-width: 6.3




sumH <- indicator |>
  filter(!is.na(sumh))


emus <- sort(unique(sumH$eel_emu_nameshort))

g <- sumH |>
  mutate(iemu = match(eel_emu_nameshort, emus)) |>
  plot_indicator_emu(1:16, ind = "sumh", ref = 0.92, ylab = expression(Sigma~H~(year^{-1})))
ggsave(g, filename = paste0(file.path(params$image_path,"trendbiomassplots/trend_sumh_1_16.png")), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trendbiomassplots/trend_sumh_1_16.png"))


```


::: {custom-style="Image Caption"}

```{r}
#| label: generateemusumh
#| echo: false
#| message: false
#| warning: false
#| output: 'asis'

src <- lapply(2:ceiling(length(emus)/16), function(i){
  imin <- (i-1) *16 +1
  imax <- i * 16
  g <- sumF |>
    mutate(iemu = match(eel_emu_nameshort, emus)) |>
    plot_indicator_emu(iemus = imin:imax,
                       ind = "sumh", 
                       ref = 0.92,
                       ylab = expression(Sigma~H~(year^{-1})))
  file <- paste0(file.path(params$image_path,"trendbiomassplots/trend_sumh_"),imin,"_",imax,".png")
  ggsave(g, filename = file, width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
  
  knit_expand(text=c(paste0('![](', file, ')'),
                     '<br>',
                     'Figure @fig-sumhtrendsemu - continue',
                     '<br>',
                     '\\newpage',
                     '\n'))
})
res <- knitr::knit_child(text = src, quiet = TRUE)
cat(res, sep = '\n')
```

:::

### Trends in total anthropogenic mortalities

```{r}
#| label: fig-sumatrendsemu
#| fig-cap: "Time series of reported sumA (year^{-1}). The horizontal red line indicates the 0.92 year^{-1} threshold."
#| fig-height: 6.3
#| fig-width: 6.3




sumA <- indicator |>
  filter(!is.na(suma))


emus <- sort(unique(sumA$eel_emu_nameshort))

g <- sumA |>
  mutate(iemu = match(eel_emu_nameshort, emus)) |>
  plot_indicator_emu(1:16, ind = "suma", ref = 0.92, ylab = expression(Sigma~A~(year^{-1})))
ggsave(g, filename = paste0(file.path(params$image_path,"trendbiomassplots/trend_suma_1_16.png")), width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
knitr::include_graphics(file.path(params$image_path,"trendbiomassplots/trend_suma_1_16.png"))


```

::: {custom-style="Image Caption"}

```{r}
#| label: generateemusuma
#| echo: false
#| message: false
#| warning: false
#| output: 'asis'

src <- lapply(2:ceiling(length(emus)/16), function(i){
  imin <- (i-1) *16 +1
  imax <- i * 16
  g <- sumF |>
    mutate(iemu = match(eel_emu_nameshort, emus)) |>
    plot_indicator_emu(iemus = imin:imax,
                       ind = "suma", 
                       ref = 0.92,
                       ylab = expression(Sigma~A~(year^{-1})))
  file <- paste0(file.path(params$image_path,"trendbiomassplots/trend_suma_"),imin,"_",imax,".png")
  ggsave(g, filename = file, width = 16 / 2.54, height = 16 / 2.54, dpi = 300)
  
  knit_expand(text=c(paste0('![](', file, ')'),
                     '<br>',
                     'Figure @fig-sumatrendsemu - continue',
                     '<br>',
                     '\\newpage',
                     '\n'))
})
res <- knitr::knit_child(text = src, quiet = TRUE)
cat(res, sep = '\n')
```

:::


# Precautionary diagrams at country scale

Figure @fig-precocountry displays the indicators aggregated by countries. The image is consistent with the picture at the EMU scale, with Ireland and EE in the green zone. Sweden shows a very high aggregated $B_{current}$/$B_0$ but this is due to the non reporting of $B_0$ in SE_East while $B_current$ is reported and large.

<br>

```{r}
#| label: fig-precocountry
#| message: false
#| warning: false
#| echo: false
#| fig-width: 6.3
#| fig-height: 3.94
#| fig-cap: "Precautionary Diagram for countries (ICES 2021b), presenting the reported data for the 2022 and 2023: status of the stock (horizontal, spawner escapement (B current) expressed as a percentage of the pristine escapement (B_0)) and the anthropogenic impacts (vertical, expressed as lifetime mortality ΣA, resp. lifetime survival %SPR). The limit anthropogenic mortality (Amgt) was set as 0.92 year^{-1}, corresponding to the 40% biomass target. Aggregation methods are detailed in SGIPEE report. Missing data might hinder the aggregation, as in Sweden where the missreporting of B_0 in SE_East leads to an overestimation of $B_{current}/B_{0}$."
#|


img <- file.path(params$image_path,"preco_country.png")
g = trace_precodiag3(precodata_all,"country",last_year=2023,years=2021:2023)
ggsave(img, height = 12/2.54, width = 16/2.54)
knitr::include_graphics(img)


```

\newpage

# References
