---
title: "WKEMP4"
date: "2025-01-24"
documentclass: report
format:
  docx:
    fig_caption: yes
    keep_md: yes
    reference-doc: "../../R/quarto/ICES_template.docx"
lang: fr
bibliography: "../../R/quarto/ICES.bib"
csl: "../../R/quarto/ices-journal-of-marine-science.csl"
crossref:
  chapters: true
  fig-prefix: ''
  tbl-prefix: ''
  eq-prefix: ''
  ref-hyperlink: true
link-citations: true
link-bibliography: true
---

```{r init}
#| echo: false
#| warning: false
#| message: false
#| 

source("../../R/quarto/quarto_utilities.R")

library(dplyr)
library(ggrepel)
library(viridis)
library(stringr)
library(vegan)
library(sf)

library(RPostgres)
library(getPass)
library(tidyr)
library(yaml)
cred=read_yaml("../../credentials.yml")
con = dbConnect(Postgres(), dbname=cred$dbname,host=cred$host,port=cred$port,user=cred$user, password=cred$password)
eu_cou_codes =c("AT",	"BE",	"BG",	"HR",	"CY",	"CZ",	"DK",	"EE",	"FI",	"FR",	"DE",	"GR",	"HU",	"IE",	"IT",	"LV",	"LT",	"LU",	"MT",	"NL",	"PL",	"PT",	"RO",	"SK",	"SI",	"ES",	"SE")
precodata_all=dbGetQuery(con,"select * from datawg.precodata_all") %>%
  filter(eel_cou_code %in% eu_cou_codes)
dbDisconnect(con)
```


```{r function}
#| echo: false


#' @title Draw background of the precautionary diagram
background2<-function(Aminimum=0,Amaximum=6.5,Bminimum=1e-2,Bmaximum=1){
  # the left of the graph is filled with polygons
  Bminimum<<-Bminimum
  Bmaximum<<-Bmaximum
  Amaximum<<-Amaximum
  Aminimum<<-Aminimum
  B<-seq(Bminimum,0.4, length.out=30)
  Amgt<-0.92
  Btrigger=0.4
  SumA<-Amgt*(B/Btrigger) # linear decrease in proportion to B/Btrigger
  X<-c(B,rev(B))
  Ylowersquare<-c(SumA,rep(Aminimum,length(B)))
  df<-data.frame("B"=X,"SumA"=Ylowersquare,"color"="orange")
  Yuppersquare<-c(SumA,rep(Amaximum,length(B)))
  df<-rbind(df, data.frame("B"=X,"SumA"=Yuppersquare,"color"="red"))
  df<-rbind(df,data.frame("B"=c(0.4,0.4,Bmaximum,Bmaximum),"SumA"=c(Aminimum,0.94,0.94,Aminimum),"color"="green")) # drawn clockwise from low left corner
  df<-rbind(df,data.frame("B"=c(0.4,0.4,Bmaximum,Bmaximum),"SumA"=c(0.94,Amaximum,Amaximum,0.94),"color"="orange1")) # drawn clockwise from low left corner
  return(df)
}

#' @title Draw precautionary diagram itself
#' @param precodata data.frame with column being: eel_emu_nameshort	bcurrent	bbest	b0	suma, using extract_data("precodata")
#' @examples
#' x11()
#' trace_precodiag(extract_data("precodata))
# TODO: offer the possibility to aggregate by country
trace_precodiag3 = function(precodata, 
                            precodata_choice=c("emu","country","all"), 
                            last_year=TRUE,
                            years,
                            stocking = TRUE)
{  
  bcurr <- "bcurrent_without_stocking"
  if (stocking) bcurr <- "bcurrent"
  ###############################
  # Data selection
  # this in done on precodata which is filtered by the app using filter_data
  #############################
  precodata$last_year[is.na(precodata$last_year)] <- precodata$eel_year[is.na(precodata$last_year)]
  if (last_year) precodata <- precodata[precodata$last_year==precodata$eel_year ,]
  precodata <- precodata %>%
    filter(eel_year %in% years)
  
  if (length(precodata_choice) >1 ) title= "Precautionary diagram" else
    switch(precodata_choice,
           "emu"={title <- "Precautionary diagram for emu"},
           "country"={title <- "Precautionary diagram for country"},
           "country_bis"={title <- "Precautionary diagram for country"},
           "all"={title <- "Precautionary diagram for all countries"},
    )
  
  precodata<-unique(precodata[precodata$aggreg_level%in%precodata_choice,])
  ############################
  # Data for buble plot 
  ############################
  mylimits=c(0,1000)
  precodata$pSpR=exp(-precodata$suma)
  precodata$pbiom=precodata$ratio_bcurrent_b0 <- precodata[, bcurr]/precodata$b0
  if (any(precodata[, bcurr]>precodata$b0,na.rm=TRUE)){
    message("You  have Bbest larger than B0, you should check \n")
    Bmaximum<-max(precodata$pbiom,na.rm=TRUE)
  } else Bmaximum=1
  if (any(is.na(precodata$b0))) message("Be careful, at least some B0 are missing")
  if (max(precodata$bbest,na.rm=TRUE)>mylimits[2]) mylimits[2]<-max(precodata$bbest,na.rm=TRUE)
  if (all(is.na(precodata$pbiom))|all(is.na(precodata$pSpR))) errortext<-"Missing data" else errortext<-""
  df<-background2(Aminimum=0,Amaximum=5,Bminimum=exp(-5),Bmaximum=Bmaximum)
  ######################
  # Drawing the graphs
  ############################
  # If EMU only show labels
  if (length(precodata_choice)==1){    
    choose_label_for_plot <- rep(TRUE,length(precodata))
    choose_color <- "eel_year"
    
    
  } else {
    
    choose_label_for_plot <- precodata$aggreg_level != "emu"
    choose_color <- "aggreg_level"
  }
  precodata$eel_year <- as.factor(precodata$eel_year)
  if (precodata_choice == "emu"){
    labels <- precodata$eel_emu_nameshort
  } else {
    labels <- precodata$eel_cou_code
  }
  g<- ggplot(df)+
    theme_bw()+
    theme(legend.key = element_rect(colour = "white"))+
    geom_polygon(aes(x=B,y=SumA,fill=color),alpha=0.7)+
    scale_fill_identity(labels=NULL)+
    scale_x_continuous(name=expression(paste(bold("Spawner escapement")~ ~over(B,B0))),
                       limits=c(Bminimum, Bmaximum),trans="log10",
                       breaks=c(0.005,0.01,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1),
                       labels=c("","1%","5%","10%","","","40%","","","","","","100%"))+ 
    scale_y_continuous(name=expression(paste(bold("Lifetime mortality")~ ~symbol("\123"),"A")),
                       limits=c(Aminimum, Amaximum)) +
    #geom_path(data = precodata,aes(x = pbiom, y = suma, group = eel_cou_code))+
    #scale_color_discrete(#guide = 'none'
    #    ) +
    geom_point(data=precodata,aes_string(x="pbiom",y="suma",size="bbest",color=choose_color), alpha=0.7)+ 
    geom_text_repel(data=precodata, aes(x=pbiom,
                                        y = suma,
                                        size=12,
                                        label = labels#,
                                        #size=bbest/8
    ),
    show.legend = FALSE      
    )+
    scale_size(name="B best (millions)",range = c(1, 12.5),limits=c(0,max(pretty(precodata$bbest))))+
    annotate("text",x =  1, y = 0.92, label = "0.92",  parse = F, hjust=1,vjust=-1.1, size=3)+
    annotate("text",x =  1, y = 0.92, label = "Amgt",  parse = F, hjust=1,vjust=1.1, size=3)+
    annotate("text",x =  0.4, y = 0, label = "Bmgt",  parse = F, hjust=0,vjust=-0.7, size=3,angle=90)+
    annotate("text",x =  0.4, y = 0, label = "Btrigger",  parse = F, hjust=0,vjust=1.1, size=3,angle=90)+
    #annotate("text",x =  0.1, y = 2, label = errortext,  parse = F, hjust=1,vjust=1, size=5,col="white")+
    annotate("text",x =  Bminimum, y = 0, label = "100% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 1.2, label = "30% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 1.6, label = "20% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 2.3, label = "10% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 2.99, label = "5% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = 4.6, label = "1% -",  parse = F, hjust=1, size=3)+
    annotate("text",x =  Bminimum, y = Amaximum, label = "%SPR",  parse = F, hjust=1,vjust=-3,size=3,angle=90)+               
    ggtitle(str_c(title))
  if(pretty(max(precodata$suma,na.rm=TRUE))[2] > 4.6)   g = g +annotate("text",x =  Bminimum, y = 4.6, label = "1%",  parse = F, hjust=1, size=3) 
  if (choose_color == "eel_year")
    g+scale_colour_viridis(discrete=TRUE) else
      g+scale_colour_brewer(palette = "Set3",direction=-1)
  
  
  return(g)
}


```


# Tor b) Evaluate the overall effectiveness of EMPs in terms of trends (or recent changes) in in achieving specific target indicators
## Changes in achieving specific target indicators
### Escapement indicators
### Mortality indicators
#### Fishing mortality
#### Other anthropogenic mortalities

## Precautionary diagram
Precautionary diagrams were proposed by ICES [@ices2010] to provide an overview of the achievement of the Eel Regulation objectives, potentially by EMUs or countries. The diagram shows the ratio of the current escapement over pristine biomass $B_0$ in x-axis, with a threshold $B_{mgt}$ set at 40% and corresponding to the Regulation target. On the y axis, reported anthropogenic mortalities $sumA$ are reported, with a threshold set at 0.92 year^-1^ which corresponds to the cumulative lifespan mortality that would allow achieving 40% of $B_{best}$. The data reported by member states are reported at the EMU scale. Aggregations at the country scale were achieved following the methods described in ICES @ices2010.

While precautionary diagrams are valuable for an easy exploration of the status of the population across EMUs or countries. However, they suffer from the lack of standardisation in assessment methods and especially of the inconsistencies in the estimation of $B_0$. Therefore, comparisons among EMUs/countries are difficult and the comparison with $B_{mgt}$ is greatly affected by inconsistencies in the estimation of $B_0$. As such, trend analysis of indicators are thought to be more informative and reliable.

Here, we will focus on the precautionary diagrams since (i) it is the scale at which data are reported and (ii) aggregation at the country scale is sensitive to missing data. The diagram at the country scale can be found in annex XX.


Few EMUs are in the green area, i.e. have both achieved the management target and reduced the anthropogenic mortality below 0.82 year^-1^ (Figure @fig-precoemu - Table @tbl-precoemu). In Ireland, the fishery ban has effectively reduced the anthropogenic mortality. As mentioned earlier, caution should be taken with the estimate of $B_0$ and therefore with the achievement of the 40% target. A few other areas are in the green area. In EE_Narv, the natural recruitment is thought to be insignificant so the situation only relies on the artificial restocking. The situation is the same (or almost the same) in German EMUs or in PL_Oder in which escapement largely relies on restocking.

Many EMUs are still in the red zone. While not achieving the 40% pristine escapement is not surprising given the current low recruitment levels, it indicates that anthropogenic mortalities have not been reduced enough yet to achieve an escapement of 40% of what would occur given current level of recruitment in the absence of any anthropogenic pressures.

```{r}
#| label: fig-precoemu
#| message: false
#| warning: false
#| echo: false
#| fig-width: 6.3
#| fig-height: 3.94
#| fig-cap: "Precautionary Diagram for Eel Management Units (ICES 2021b), presenting the reported data for the 2022 and 2023: status of the stock (horizontal, spawner escapement (B current) expressed as a percentage of the pristine escapement (B0)) and the anthropogenic impacts (vertical, expressed as lifetime mortality ΣA, resp. lifetime survival %SPR). The limit anthropogenic mortality (Amgt) was set as 0.92, corresponding to the 40% biomass limit (B mgt)."
#|
img <- "2024/image/preco_emu.png"
g = trace_precodiag3(precodata_all,"emu",last_year=2023,years=2022:2023)
ggsave(img, height = 12/2.54, width = 16/2.54)
knitr::include_graphics(img)


```
<br>

```{r}
#| label: tbl-precoemu
#| message: false
#| warning: false
#| echo: false
#| tab-cap: "Position of EMUs in the precautionary diagram. The colours stand for the zones in the diagram."
#|
precodata_all |>
  filter(aggreg_level == "emu",
         eel_year %in% 2022:2023) |>
  mutate(isbtarget = (bcurrent/b0)>=0.4,
         issum = suma <=0.92) |>
  mutate(zone = isbtarget + issum) |>
  select(eel_cou_code,eel_emu_nameshort,eel_year,zone) |>
  filter(!is.na(zone)) |>
  pivot_wider(id_cols = all_of(c("eel_cou_code","eel_emu_nameshort")),
              names_from = eel_year,
              values_from = zone) |>
  arrange(eel_cou_code,eel_emu_nameshort) |>
  rename(Country = eel_cou_code,
         EMU = eel_emu_nameshort) |>
  flextable() |>
  flextable::bg(j=3, i=~(`2022`==0),bg="red", part = "body") |>
  flextable::bg(j=3, i= ~(`2022`==1),bg="orange", part = "body") |>
  flextable::bg(j=3, i= ~ (`2022`==2), bg="green", part = "body") |>
  flextable::bg(j=4, i=~(`2023`==0),bg="red", part = "body") |>
  flextable::bg(j=4, i= ~(`2023`==1),bg="orange", part = "body") |>
  flextable::bg(j=4, i= ~ (`2023`==2), bg="green", part = "body") |>
  flextable::void(j = 3:4) |>
  flextable2ICES()
  
  

```
<br>


\newpage
::: {custom-style="Annex heading"}
Precautionary diagram at country scale
:::



# Precautionary diagrams at country scale
Figure @fig-precocountry displays the indicators aggregated by countries. The image is consistent with the picture at the EMU scale, with Ireland and EE in the green zone. Sweden shows a very high aggregated $B_{current}$/$B_0$ but this is due to the non reporting of $B_0$ in SE_East while $B_current$ is reported and large.

<br>

```{r}
#| label: fig-precocountry
#| message: false
#| warning: false
#| echo: false
#| fig-width: 6.3
#| fig-height: 3.94
#| fig-cap: "Precautionary Diagram for countries (ICES 2021b), presenting the reported data for the 2022 and 2023: status of the stock (horizontal, spawner escapement (B current) expressed as a percentage of the pristine escapement (B0)) and the anthropogenic impacts (vertical, expressed as lifetime mortality ΣA, resp. lifetime survival %SPR). The limit anthropogenic mortality (Amgt) was set as 0.92, corresponding to the 40% biomass limit (B mgt). Aggregation methods are detailed in SGIPEE report. Missing data might hinder the aggregation, as in Sweden where the missreporting of B0 in SE_East leads to an overestimation of Bcurrent/B0."
#|


img <- "2024/image/preco_country.png"
g = trace_precodiag3(precodata_all,"country",last_year=2023,years=2022:2023)
ggsave(img, height = 12/2.54, width = 16/2.54)
knitr::include_graphics(img)


```


\newpage 
# References